<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0c0a1d">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230c0a1d' width='100' height='100' rx='20'/><circle cx='50' cy='50' r='35' fill='%23a5b4fc'/><circle cx='65' cy='40' r='30' fill='%230c0a1d'/></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230c0a1d' width='100' height='100' rx='20'/><circle cx='50' cy='50' r='35' fill='%23a5b4fc'/><circle cx='65' cy='40' r='30' fill='%230c0a1d'/></svg>">
  <title>Symptom Tracker</title>
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #0c0a1d;
      overflow: hidden;
    }
    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      min-height: 100dvh;
      background: #0c0a1d;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: fixed;
      width: 100%;
      overflow: hidden;
    }
    #root {
      margin: 0;
      padding: 0;
      height: 100%;
      height: 100dvh;
      background: #0c0a1d;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }
    body.no-scroll {
      touch-action: none;
    }
    body.no-scroll #root {
      overflow: hidden;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  
  <script type="text/babel">
    const { useState, useRef, useEffect } = React;
// Google Drive Configuration
// To use Google sync, create a project at https://console.cloud.google.com
// 1. Create OAuth 2.0 credentials (Web application)
// 2. Add your domain to authorized JavaScript origins
// 3. Enable Google Drive API
// 4. Replace the CLIENT_ID below with your own
const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com';
const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
const SYNC_FILENAME = 'symptom-tracker-data.json';

const defaultSymptoms = [];

const sampleSymptoms = [
  { id: 'daytime-fatigue', name: 'Daytime fatigue', active: true },
  { id: 'irritability', name: 'Irritability', active: true },
  { id: 'air-hunger-am', name: 'Air hunger AM', active: true },
  { id: 'nerve-pain', name: 'Nerve pain / neuropathy', active: true },
  { id: 'headache', name: 'Headache', active: true },
  { id: 'psoriasis', name: 'Psoriasis', active: true },
  { id: 'brain-fog', name: 'Brain fog', active: true },
  { id: 'heartburn', name: 'Heartburn / bile reflux', active: true },
];

const sampleStackItems = [
  { id: 'b1-benfotiamine', name: 'B1 Benfotiamine', unit: 'mg', defaultDose: 200, active: true, order: 0 },
  { id: 'b2', name: 'B2', unit: 'mg', defaultDose: 250, active: true, order: 1 },
  { id: 'b3', name: 'B3', unit: 'mg', defaultDose: 50, active: true, order: 2 },
  { id: 'l-methylfolate', name: 'L-methylfolate', unit: 'mcg', defaultDose: 200, active: true, order: 3 },
  { id: 'methyl-b12', name: 'Methyl-B12', unit: 'mcg', defaultDose: 250, active: true, order: 4 },
  { id: 'd3', name: 'D3', unit: 'IU', defaultDose: 5000, active: true, order: 5 },
  { id: 'quercetin', name: 'Quercetin', unit: 'mg', defaultDose: 500, active: true, order: 6 },
  { id: 'vitamin-c', name: 'Vitamin C', unit: 'mg', defaultDose: 2000, active: true, order: 7 },
  { id: 'glycine', name: 'Glycine', unit: 'g', defaultDose: 3, active: true, order: 8 },
  { id: 'magnesium', name: 'Magnesium (biglycinate + threonate)', unit: 'mg', defaultDose: 600, active: true, order: 9 },
  { id: 'butyrate', name: 'Butyrate', unit: 'mg', defaultDose: 200, active: true, order: 10 },
  { id: 'ketotifen', name: 'Ketotifen', unit: 'mg', defaultDose: 1, active: true, order: 11 },
];

// Default stack is user's actual stack
const defaultStackItems = [...sampleStackItems];

const STORAGE_KEY_STACK_ITEMS = 'symptomTracker_stackItems';
const STORAGE_KEY_STACK_ENTRIES = 'symptomTracker_stackEntries';
const STORAGE_KEY_APP_MODE = 'symptomTracker_appMode';

const allTimePeriods = [
  { id: 'night', label: 'Night', icon: '☽' },
  { id: 'morning', label: 'Morning', icon: '◐' },
  { id: 'allday', label: 'All Day', icon: '○' },
  { id: 'midday', label: 'Midday', icon: '●' },
  { id: 'evening', label: 'Evening', icon: '◑' },
];

const trackingModes = {
  simple: {
    label: 'Simple',
    description: 'One entry per day',
    periods: [{ id: 'daily', label: 'Daily', icon: '○' }],
  },
  ampm: {
    label: 'AM/PM',
    description: 'Morning and evening',
    periods: [
      { id: 'morning', label: 'AM', icon: '◐' },
      { id: 'evening', label: 'PM', icon: '◑' },
    ],
  },
  detailed: {
    label: 'Detailed',
    description: 'Five time periods',
    periods: allTimePeriods,
  },
};

const STORAGE_KEY_MODE = 'symptomTracker_mode';

const severityLevels = [0, 1, 2, 3, 4, 5];
const severityColors = {
  0: '#22c55e',
  1: '#4ade80',
  2: '#a3e635',
  3: '#facc15',
  4: '#fb923c',
  5: '#ef4444',
};
const severityLabels = ['None', 'Minimal', 'Mild', 'Moderate', 'Severe', 'Extreme'];

const STORAGE_KEY_SYMPTOMS = 'symptomTracker_symptoms';
const STORAGE_KEY_ENTRIES = 'symptomTracker_entries';

const generateSampleData = (symptoms, mode = 'detailed') => {
  const entries = {};
  const today = new Date();
  const periods = trackingModes[mode].periods;
  
  // Define symptom clusters that tend to appear together
  const clusters = {
    fatigue: ['daytime-fatigue', 'brain-fog', 'air-hunger-am'],
    pain: ['headache', 'nerve-pain'],
    digestive: ['heartburn', 'irritability'],
  };
  
  // Monthly trend modifiers (6 months back) - some symptoms improve, some worsen
  const monthlyTrends = {
    'headache': [1.5, 1.3, 1.2, 1.0, 0.8, 0.7], // improving
    'brain-fog': [1.4, 1.3, 1.1, 1.0, 0.9, 0.8], // improving
    'heartburn': [1.2, 1.0, 0.8, 1.0, 1.2, 1.0], // cyclical
    'daytime-fatigue': [1.0, 1.0, 1.0, 1.0, 1.0, 1.0], // stable
    'psoriasis': [0.5, 0.6, 0.8, 1.0, 1.2, 1.3], // worsening
    'irritability': [0.7, 0.8, 0.9, 1.0, 1.1, 1.2], // worsening
  };

  // Weekly patterns (0 = Sunday)
  const weekendEffect = {
    'headache': [1.2, 1.1, 0.9, 0.9, 0.9, 1.0, 1.1], // Monday headaches
  };
  
  for (let daysAgo = 0; daysAgo < 180; daysAgo++) {
    const date = new Date(today);
    date.setDate(date.getDate() - daysAgo);
    const dateKey = date.toISOString().split('T')[0];
    const monthsAgo = Math.floor(daysAgo / 30);
    const dayOfWeek = date.getDay();
    
    if (Math.random() < 0.85) {
      // Pick 2-4 symptoms, with cluster correlation
      let selectedSymptomIds = [];
      const activeSymptoms = symptoms.filter(s => s.active);
      
      // 40% chance to activate a cluster
      if (Math.random() < 0.4) {
        const clusterNames = Object.keys(clusters);
        const cluster = clusters[clusterNames[Math.floor(Math.random() * clusterNames.length)]];
        const clusterSymptoms = cluster.filter(id => 
          activeSymptoms.some(s => s.id === id)
        );
        if (clusterSymptoms.length > 0) {
          const numFromCluster = Math.min(clusterSymptoms.length, Math.floor(Math.random() * 2) + 1);
          selectedSymptomIds = clusterSymptoms.slice(0, numFromCluster);
        }
      }
      
      // Add random symptoms
      const numAdditional = Math.floor(Math.random() * 2) + 1;
      const otherSymptoms = activeSymptoms
        .filter(s => !selectedSymptomIds.includes(s.id))
        .sort(() => Math.random() - 0.5)
        .slice(0, numAdditional)
        .map(s => s.id);
      
      selectedSymptomIds = [...selectedSymptomIds, ...otherSymptoms];
      
      selectedSymptomIds.forEach(symptomId => {
        const numPeriods = mode === 'simple' ? 1 : (Math.random() < 0.7 ? 1 : 2);
        const shuffledPeriods = [...periods].sort(() => Math.random() - 0.5).slice(0, numPeriods);
        
        shuffledPeriods.forEach(period => {
          let baseSeverity = Math.floor(Math.random() * 4) + 1;
          
          // Apply monthly trend
          const trend = monthlyTrends[symptomId];
          if (trend && monthsAgo < trend.length) {
            baseSeverity = Math.round(baseSeverity * trend[monthsAgo]);
          }
          
          // Apply weekly pattern
          const weekPattern = weekendEffect[symptomId];
          if (weekPattern) {
            baseSeverity = Math.round(baseSeverity * weekPattern[dayOfWeek]);
          }
          
          // Morning symptoms tend to be worse for some
          if (period.id === 'morning' && ['headache', 'air-hunger-am'].includes(symptomId)) {
            baseSeverity = Math.min(5, baseSeverity + 1);
          }
          
          const key = `${dateKey}-${symptomId}-${period.id}`;
          entries[key] = {
            time: period.id,
            severity: Math.min(5, Math.max(1, baseSeverity)),
            date: dateKey,
            symptomId: symptomId
          };
        });
      });
    }
  }
  
  return entries;
};

function SymptomTrackerMobile() {
  // App mode: 'symptoms' or 'stack' - always start on symptoms
  const [appMode, setAppMode] = useState('symptoms');
  
  const [symptoms, setSymptoms] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY_SYMPTOMS);
    return saved ? JSON.parse(saved) : defaultSymptoms;
  });
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [entries, setEntries] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY_ENTRIES);
    return saved ? JSON.parse(saved) : {};
  });
  
  // Stack state
  const [stackItems, setStackItems] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY_STACK_ITEMS);
    return saved ? JSON.parse(saved) : defaultStackItems;
  });
  const [stackEntries, setStackEntries] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY_STACK_ENTRIES);
    return saved ? JSON.parse(saved) : {};
  });
  const [editingStackItem, setEditingStackItem] = useState(null);
  const [showManageStack, setShowManageStack] = useState(false);
  const [showAddStackItem, setShowAddStackItem] = useState(false);
  const [newStackItem, setNewStackItem] = useState({ name: '', unit: 'mg', defaultDose: '' });
  
  const [hasSampleData, setHasSampleData] = useState(false);
  const [trackingMode, setTrackingMode] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY_MODE);
    return saved || 'ampm';
  });
  const [showInsights, setShowInsights] = useState(false);
  const [insightsWindow, setInsightsWindow] = useState(60);
  
  // Google Drive sync state
  const [googleUser, setGoogleUser] = useState(null);
  const [syncStatus, setSyncStatus] = useState('idle'); // idle, syncing, success, error
  const [lastSyncTime, setLastSyncTime] = useState(() => {
    const saved = localStorage.getItem('symptomTracker_lastSync');
    return saved ? new Date(saved) : null;
  });
  const [googleApiReady, setGoogleApiReady] = useState(false);
  const tokenClientRef = useRef(null);
  
  // Derived time periods based on mode
  const timePeriods = trackingModes[trackingMode].periods;
  
  const [activeSymptom, setActiveSymptom] = useState(null);
  const [dragPosition, setDragPosition] = useState({ x: 2, y: 2 });
  const [isDragging, setIsDragging] = useState(false);
  const [fingerPosition, setFingerPosition] = useState({ x: 0, y: 0 });
  const [lastAction, setLastAction] = useState('');
  const [showAddSymptom, setShowAddSymptom] = useState(false);
  const [showCalendar, setShowCalendar] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [showExport, setShowExport] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [openedFromSettings, setOpenedFromSettings] = useState(false);
  const [confirmClearData, setConfirmClearData] = useState(false);
  const [editingSymptomId, setEditingSymptomId] = useState(null);
  const [editingSymptomName, setEditingSymptomName] = useState('');
  const [bulkSymptomInput, setBulkSymptomInput] = useState('');
  const [calendarMonth, setCalendarMonth] = useState(new Date());
  const [historySort, setHistorySort] = useState({ column: 'date', direction: 'desc' });
  const containerRef = useRef(null);
  const startPosRef = useRef({ x: 0, y: 0 });
  const holdTimerRef = useRef(null);
  const pendingSymptomRef = useRef(null);
  const isDraggingRef = useRef(false);

  const DRAG_SENSITIVITY = 19;
  const HOLD_DELAY = 200;

  // Keep ref in sync with state
  useEffect(() => {
    isDraggingRef.current = isDragging;
  }, [isDragging]);

  // Auto-clear lastAction after 3 seconds
  useEffect(() => {
    if (lastAction) {
      const timer = setTimeout(() => {
        setLastAction('');
      }, 3000);
      return () => clearTimeout(timer);
    }
  }, [lastAction]);

  // Reset confirmClearData when leaving Settings
  useEffect(() => {
    if (!showSettings) {
      setConfirmClearData(false);
    }
  }, [showSettings]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_SYMPTOMS, JSON.stringify(symptoms));
  }, [symptoms]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_ENTRIES, JSON.stringify(entries));
  }, [entries]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_MODE, trackingMode);
  }, [trackingMode]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_APP_MODE, appMode);
  }, [appMode]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_STACK_ITEMS, JSON.stringify(stackItems));
  }, [stackItems]);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY_STACK_ENTRIES, JSON.stringify(stackEntries));
  }, [stackEntries]);

  // Initialize Google API
  useEffect(() => {
    if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com') {
      return; // Skip if not configured
    }
    
    const initGoogle = () => {
      if (window.google && window.gapi) {
        // Initialize GAPI client
        window.gapi.load('client', async () => {
          await window.gapi.client.init({});
          await window.gapi.client.load('drive', 'v3');
          setGoogleApiReady(true);
          
          // Initialize token client
          tokenClientRef.current = window.google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES,
            callback: (tokenResponse) => {
              if (tokenResponse.access_token) {
                setGoogleUser({ accessToken: tokenResponse.access_token });
                loadFromGoogleDrive();
              }
            },
          });
          
          // Check for existing token
          const savedToken = localStorage.getItem('symptomTracker_googleToken');
          if (savedToken) {
            try {
              window.gapi.client.setToken({ access_token: savedToken });
              setGoogleUser({ accessToken: savedToken });
            } catch (e) {
              localStorage.removeItem('symptomTracker_googleToken');
            }
          }
        });
      }
    };
    
    // Wait for scripts to load
    const checkScripts = setInterval(() => {
      if (window.google && window.gapi) {
        clearInterval(checkScripts);
        initGoogle();
      }
    }, 100);
    
    return () => clearInterval(checkScripts);
  }, []);

  const handleGoogleSignIn = () => {
    if (tokenClientRef.current) {
      tokenClientRef.current.requestAccessToken({ prompt: 'consent' });
    }
  };

  const handleGoogleSignOut = () => {
    if (googleUser?.accessToken) {
      window.google.accounts.oauth2.revoke(googleUser.accessToken);
    }
    window.gapi.client.setToken(null);
    setGoogleUser(null);
    localStorage.removeItem('symptomTracker_googleToken');
    localStorage.removeItem('symptomTracker_lastSync');
    setLastSyncTime(null);
    setSyncStatus('idle');
  };

  const findOrCreateFile = async () => {
    // Search for existing file
    const response = await window.gapi.client.drive.files.list({
      spaces: 'appDataFolder',
      q: `name='${SYNC_FILENAME}'`,
      fields: 'files(id, name)',
    });
    
    if (response.result.files && response.result.files.length > 0) {
      return response.result.files[0].id;
    }
    
    // Create new file
    const createResponse = await window.gapi.client.drive.files.create({
      resource: {
        name: SYNC_FILENAME,
        parents: ['appDataFolder'],
      },
      fields: 'id',
    });
    
    return createResponse.result.id;
  };

  const saveToGoogleDrive = async () => {
    if (!googleUser || !googleApiReady) return;
    
    setSyncStatus('syncing');
    try {
      const fileId = await findOrCreateFile();
      const data = {
        symptoms,
        entries,
        trackingMode,
        lastModified: new Date().toISOString(),
      };
      
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${googleUser.accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      
      const now = new Date();
      setLastSyncTime(now);
      localStorage.setItem('symptomTracker_lastSync', now.toISOString());
      localStorage.setItem('symptomTracker_googleToken', googleUser.accessToken);
      setSyncStatus('success');
      setLastAction('Synced to Google Drive');
      
      setTimeout(() => setSyncStatus('idle'), 2000);
    } catch (error) {
      console.error('Save to Google Drive failed:', error);
      setSyncStatus('error');
      setLastAction('Sync failed');
      setTimeout(() => setSyncStatus('idle'), 3000);
    }
  };

  const loadFromGoogleDrive = async () => {
    if (!googleUser || !googleApiReady) return;
    
    setSyncStatus('syncing');
    try {
      const response = await window.gapi.client.drive.files.list({
        spaces: 'appDataFolder',
        q: `name='${SYNC_FILENAME}'`,
        fields: 'files(id, name)',
      });
      
      if (!response.result.files || response.result.files.length === 0) {
        setSyncStatus('idle');
        return;
      }
      
      const fileId = response.result.files[0].id;
      const fileResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
        headers: {
          'Authorization': `Bearer ${googleUser.accessToken}`,
        },
      });
      
      if (fileResponse.ok) {
        const data = await fileResponse.json();
        if (data.symptoms) setSymptoms(data.symptoms);
        if (data.entries) setEntries(data.entries);
        if (data.trackingMode) setTrackingMode(data.trackingMode);
        
        const now = new Date();
        setLastSyncTime(now);
        localStorage.setItem('symptomTracker_lastSync', now.toISOString());
        localStorage.setItem('symptomTracker_googleToken', googleUser.accessToken);
        setSyncStatus('success');
        setLastAction('Loaded from Google Drive');
      }
      
      setTimeout(() => setSyncStatus('idle'), 2000);
    } catch (error) {
      console.error('Load from Google Drive failed:', error);
      setSyncStatus('error');
      setTimeout(() => setSyncStatus('idle'), 3000);
    }
  };

  // Lock body scroll when dragging - iOS Safari fix
  useEffect(() => {
    const preventScroll = (e) => {
      if (isDraggingRef.current) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    };
    
    // Add listener once with passive: false
    document.addEventListener('touchmove', preventScroll, { passive: false });
    
    return () => {
      document.removeEventListener('touchmove', preventScroll);
    };
  }, []);

  // Manage body class for scroll lock
  useEffect(() => {
    if (isDragging) {
      document.body.classList.add('no-scroll');
      document.documentElement.style.overflow = 'hidden';
    } else {
      document.body.classList.remove('no-scroll');
      document.documentElement.style.overflow = '';
    }
    return () => {
      document.body.classList.remove('no-scroll');
      document.documentElement.style.overflow = '';
    };
  }, [isDragging]);

  const getDateKey = (date) => date.toISOString().split('T')[0];

  const formatDate = (date) => {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    if (date.toDateString() === today.toDateString()) return 'Today';
    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
    if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
    
    return date.toLocaleDateString('en-US', { 
      weekday: 'short', 
      month: 'short', 
      day: 'numeric' 
    });
  };

  const formatTableDate = (dateStr) => {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: '2-digit'
    });
  };

  const loadSampleData = () => {
    // Load symptom sample data
    setSymptoms(sampleSymptoms);
    const sampleEntries = generateSampleData(sampleSymptoms, trackingMode);
    setEntries(sampleEntries);
    
    // Load stack sample data
    setStackItems(sampleStackItems);
    const sampleStackEntries = generateSampleStackData(sampleStackItems);
    setStackEntries(sampleStackEntries);
    
    setHasSampleData(true);
    setShowSettings(false);
    setLastAction(`Loaded sample data: ${sampleSymptoms.length} symptoms, ${sampleStackItems.length} supplements`);
  };

  const clearAllData = () => {
    if (!confirmClearData) {
      setConfirmClearData(true);
      return;
    }
    setEntries({});
    setStackEntries({});
    setHasSampleData(false);
    setConfirmClearData(false);
    setShowSettings(false);
    setLastAction('All data cleared');
  };

  // Helper to close History and return to Settings if opened from there
  const closeHistory = () => {
    setShowHistory(false);
    if (openedFromSettings) {
      setOpenedFromSettings(false);
      setShowSettings(true);
    }
  };

  // Helper to close Export and return to Settings if opened from there
  const closeExport = () => {
    setShowExport(false);
    if (openedFromSettings) {
      setOpenedFromSettings(false);
      setShowSettings(true);
    }
  };

  // Backup all data to a JSON file (save to iCloud via Files app)
  const backupToFile = () => {
    const backup = {
      version: '1.6',
      exportedAt: new Date().toISOString(),
      symptoms,
      entries,
      stackItems,
      stackEntries,
      trackingMode,
    };
    
    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `symptom-tracker-backup-${getDateKey(new Date())}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setLastAction('Backup downloaded - save to iCloud Drive');
  };

  // Restore data from a JSON backup file
  const restoreFromFile = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const backup = JSON.parse(e.target.result);
        
        if (backup.symptoms) setSymptoms(backup.symptoms);
        if (backup.entries) setEntries(backup.entries);
        if (backup.stackItems) setStackItems(backup.stackItems);
        if (backup.stackEntries) setStackEntries(backup.stackEntries);
        if (backup.trackingMode) setTrackingMode(backup.trackingMode);
        
        setLastAction(`Restored backup from ${backup.exportedAt ? new Date(backup.exportedAt).toLocaleDateString() : 'file'}`);
        setShowSettings(false);
      } catch (err) {
        setLastAction('Error: Invalid backup file');
      }
    };
    reader.readAsText(file);
    // Reset the input so the same file can be selected again
    event.target.value = '';
  };

  // Hidden file input ref for restore
  const fileInputRef = useRef(null);

  // Generate sample stack entries for past 180 days
  const generateSampleStackData = (items) => {
    const entries = {};
    const today = new Date();
    
    for (let daysAgo = 0; daysAgo < 180; daysAgo++) {
      const date = new Date(today);
      date.setDate(date.getDate() - daysAgo);
      const dateKey = date.toISOString().split('T')[0];
      
      // 90% chance of taking supplements on any given day
      if (Math.random() < 0.9) {
        items.filter(item => item.active).forEach(item => {
          // 85% chance of taking each individual supplement
          if (Math.random() < 0.85) {
            const key = `${dateKey}-${item.id}`;
            // Occasionally vary the dose
            let dose = item.defaultDose;
            if (Math.random() < 0.1) {
              dose = Math.round(dose * (0.5 + Math.random()));
            }
            entries[key] = {
              date: dateKey,
              itemId: item.id,
              dose: dose,
              taken: true
            };
          }
        });
      }
    }
    
    return entries;
  };

  // Stack functions
  const toggleStackItem = (itemId) => {
    const dateKey = getDateKey(selectedDate);
    const entryKey = `${dateKey}-${itemId}`;
    const item = stackItems.find(i => i.id === itemId);
    
    if (stackEntries[entryKey]) {
      // Remove entry (toggle off)
      const newEntries = { ...stackEntries };
      delete newEntries[entryKey];
      setStackEntries(newEntries);
      setLastAction(`Removed ${item?.name}`);
    } else {
      // Add entry at default dose
      setStackEntries({
        ...stackEntries,
        [entryKey]: {
          date: dateKey,
          itemId: itemId,
          dose: item?.defaultDose || 0,
          taken: true
        }
      });
      setLastAction(`Took ${item?.name}`);
    }
  };

  const updateStackDose = (itemId, newDose) => {
    const dateKey = getDateKey(selectedDate);
    const entryKey = `${dateKey}-${itemId}`;
    const item = stackItems.find(i => i.id === itemId);
    
    setStackEntries({
      ...stackEntries,
      [entryKey]: {
        date: dateKey,
        itemId: itemId,
        dose: parseFloat(newDose) || 0,
        taken: true
      }
    });
    setEditingStackItem(null);
    setLastAction(`Updated ${item?.name} to ${newDose}${item?.unit}`);
  };

  const getStackEntry = (itemId) => {
    const dateKey = getDateKey(selectedDate);
    return stackEntries[`${dateKey}-${itemId}`];
  };

  const getStackProgress = () => {
    const dateKey = getDateKey(selectedDate);
    const activeItems = stackItems.filter(i => i.active);
    const takenCount = activeItems.filter(item => 
      stackEntries[`${dateKey}-${item.id}`]
    ).length;
    return { taken: takenCount, total: activeItems.length };
  };

  const addStackItem = () => {
    if (!newStackItem.name.trim() || !newStackItem.defaultDose) return;
    
    const id = newStackItem.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
    const maxOrder = Math.max(-1, ...stackItems.map(i => i.order || 0));
    
    setStackItems([...stackItems, {
      id: id,
      name: newStackItem.name.trim(),
      unit: newStackItem.unit,
      defaultDose: parseFloat(newStackItem.defaultDose),
      active: true,
      order: maxOrder + 1
    }]);
    
    setNewStackItem({ name: '', unit: 'mg', defaultDose: '' });
    setShowAddStackItem(false);
    setLastAction(`Added ${newStackItem.name}`);
  };

  const toggleStackItemActive = (itemId) => {
    setStackItems(stackItems.map(item =>
      item.id === itemId ? { ...item, active: !item.active } : item
    ));
  };

  const copyYesterdayStack = (silent = false) => {
    const today = new Date(selectedDate);
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayKey = getDateKey(yesterday);
    const todayKey = getDateKey(today);
    
    const yesterdayEntries = Object.entries(stackEntries)
      .filter(([key]) => key.startsWith(yesterdayKey));
    
    if (yesterdayEntries.length === 0) {
      if (!silent) setLastAction('No entries from yesterday to copy');
      return false;
    }
    
    const newEntries = { ...stackEntries };
    yesterdayEntries.forEach(([key, entry]) => {
      const newKey = key.replace(yesterdayKey, todayKey);
      newEntries[newKey] = { ...entry, date: todayKey };
    });
    
    setStackEntries(newEntries);
    if (!silent) setLastAction(`Copied ${yesterdayEntries.length} items from yesterday`);
    return true;
  };

  // Auto-select all active supplements at default dose for a date
  const autoSelectAllSupplements = (dateKey) => {
    const activeItems = stackItems.filter(i => i.active);
    if (activeItems.length === 0) return;
    
    const newEntries = { ...stackEntries };
    activeItems.forEach(item => {
      const entryKey = `${dateKey}-${item.id}`;
      if (!newEntries[entryKey]) {
        newEntries[entryKey] = {
          date: dateKey,
          itemId: item.id,
          dose: item.defaultDose,
          taken: true
        };
      }
    });
    setStackEntries(newEntries);
  };

  // Track which dates we've auto-selected for
  const autoSelectedDatesRef = useRef(new Set());

  // Auto-select all supplements when viewing stack with no entries for current day
  useEffect(() => {
    if (appMode !== 'stack') return;
    
    const todayKey = getDateKey(selectedDate);
    
    // Don't auto-select if we've already done it for this date
    if (autoSelectedDatesRef.current.has(todayKey)) return;
    
    const todayEntries = Object.keys(stackEntries).filter(key => key.startsWith(todayKey));
    
    // Only auto-select if today has no entries and there are active stack items
    if (todayEntries.length === 0 && stackItems.filter(i => i.active).length > 0) {
      autoSelectedDatesRef.current.add(todayKey);
      autoSelectAllSupplements(todayKey);
    }
  }, [appMode, selectedDate]);

  const changeDate = (days) => {
    const newDate = new Date(selectedDate);
    newDate.setDate(newDate.getDate() + days);
    
    // Don't allow navigation to future dates
    const today = new Date();
    today.setHours(23, 59, 59, 999);
    if (newDate > today) return;
    
    setSelectedDate(newDate);
    setLastAction('');
  };

  const selectDate = (date) => {
    // Don't allow selection of future dates
    const today = new Date();
    today.setHours(23, 59, 59, 999);
    if (date > today) return;
    
    setSelectedDate(date);
    setShowCalendar(false);
    setLastAction('');
  };
  
  // Check if we can navigate forward
  const canGoForward = () => {
    const tomorrow = new Date(selectedDate);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const today = new Date();
    today.setHours(23, 59, 59, 999);
    return tomorrow <= today;
  };

  const enterEditMode = (symptomId, clientX, clientY) => {
    const screenHeight = window.innerHeight;
    const relativeY = clientY / screenHeight;
    let initialSeverity;
    if (relativeY < 0.25) {
      initialSeverity = 5;
    } else if (relativeY > 0.75) {
      initialSeverity = 0;
    } else {
      initialSeverity = 2;
    }
    
    // Calculate time index based on mode
    let clampedTimeIndex = 0;
    if (trackingMode !== 'simple') {
      const screenWidth = window.innerWidth;
      const numPeriods = timePeriods.length;
      const timeIndex = Math.floor((clientX / screenWidth) * numPeriods);
      clampedTimeIndex = Math.max(0, Math.min(numPeriods - 1, timeIndex));
    }
    
    setActiveSymptom(symptomId);
    setDragPosition({ x: clampedTimeIndex, y: initialSeverity });
    isDraggingRef.current = true;
    setIsDragging(true);
    pendingSymptomRef.current = null;
  };

  const handleTouchStart = (e, symptomId) => {
    const touch = e.touches[0];
    startPosRef.current = { x: touch.clientX, y: touch.clientY };
    setFingerPosition({ x: touch.clientX, y: touch.clientY });
    pendingSymptomRef.current = symptomId;
    
    holdTimerRef.current = setTimeout(() => {
      if (pendingSymptomRef.current === symptomId) {
        enterEditMode(symptomId, touch.clientX, touch.clientY);
      }
    }, HOLD_DELAY);
  };

  const handleMouseDown = (e, symptomId) => {
    e.preventDefault();
    startPosRef.current = { x: e.clientX, y: e.clientY };
    setFingerPosition({ x: e.clientX, y: e.clientY });
    pendingSymptomRef.current = symptomId;
    
    holdTimerRef.current = setTimeout(() => {
      if (pendingSymptomRef.current === symptomId) {
        enterEditMode(symptomId, e.clientX, e.clientY);
      }
    }, HOLD_DELAY);
  };

  const handleMove = (clientX, clientY) => {
    if (pendingSymptomRef.current && !isDragging) {
      const deltaX = Math.abs(clientX - startPosRef.current.x);
      const deltaY = Math.abs(clientY - startPosRef.current.y);
      
      if (deltaX > 10 || deltaY > 10) {
        if (holdTimerRef.current) {
          clearTimeout(holdTimerRef.current);
          holdTimerRef.current = null;
        }
        pendingSymptomRef.current = null;
      }
      return;
    }
    
    if (!isDragging || !activeSymptom) return;
    
    setFingerPosition({ x: clientX, y: clientY });
    
    // Calculate time index based on mode
    let timeIndex = 0;
    if (trackingMode !== 'simple') {
      const screenWidth = window.innerWidth;
      const numPeriods = timePeriods.length;
      timeIndex = Math.floor((clientX / screenWidth) * numPeriods);
      timeIndex = Math.max(0, Math.min(numPeriods - 1, timeIndex));
    }
    
    const deltaY = startPosRef.current.y - clientY;
    let severityDelta = Math.round(deltaY / DRAG_SENSITIVITY);
    
    const screenHeight = window.innerHeight;
    const relativeStartY = startPosRef.current.y / screenHeight;
    let baseSeverity;
    if (relativeStartY < 0.25) {
      baseSeverity = 5;
    } else if (relativeStartY > 0.75) {
      baseSeverity = 0;
    } else {
      baseSeverity = 2;
    }
    
    let severityIndex = baseSeverity + severityDelta;
    severityIndex = Math.max(0, Math.min(5, severityIndex));
    
    setDragPosition({ x: timeIndex, y: severityIndex });
  };

  const handleTouchMove = (e) => {
    if (isDragging) {
      e.preventDefault();
    }
    const touch = e.touches[0];
    handleMove(touch.clientX, touch.clientY);
  };

  const handleMouseMove = (e) => {
    handleMove(e.clientX, e.clientY);
  };

  const handleEnd = () => {
    if (holdTimerRef.current) {
      clearTimeout(holdTimerRef.current);
      holdTimerRef.current = null;
    }
    pendingSymptomRef.current = null;
    
    if (isDragging && activeSymptom) {
      const dateKey = getDateKey(selectedDate);
      const timeId = timePeriods[dragPosition.x].id;
      const severity = dragPosition.y;
      const key = `${dateKey}-${activeSymptom}-${timeId}`;
      
      setEntries({
        ...entries,
        [key]: { time: timeId, severity, date: dateKey, symptomId: activeSymptom }
      });
      
      const symptom = symptoms.find(s => s.id === activeSymptom);
      setLastAction(`${symptom?.name}: ${timePeriods[dragPosition.x].label}, ${severity}`);
    }
    isDraggingRef.current = false;
    setIsDragging(false);
    setActiveSymptom(null);
  };

  const getSymptomEntries = (symptomId) => {
    const dateKey = getDateKey(selectedDate);
    const timeOrder = { night: 0, morning: 1, allday: 2, midday: 3, evening: 4, daily: 2 };
    return Object.entries(entries)
      .filter(([key]) => key.startsWith(`${dateKey}-${symptomId}`))
      .map(([key, value]) => value)
      .sort((a, b) => (timeOrder[a.time] || 0) - (timeOrder[b.time] || 0));
  };

  const getDaysWithEntries = () => {
    const days = new Set();
    Object.keys(entries).forEach(key => {
      const dateKey = key.split('-').slice(0, 3).join('-');
      days.add(dateKey);
    });
    return days;
  };

  const parseBulkSymptoms = (input) => {
    return input
      .split(/[,\t\n\r;]+/)
      .map(s => s.trim())
      .filter(s => s.length > 0);
  };

  const addBulkSymptoms = () => {
    const names = parseBulkSymptoms(bulkSymptomInput);
    if (names.length === 0) return;

    const newSymptoms = [...symptoms];
    let addedCount = 0;

    names.forEach(name => {
      const existing = newSymptoms.find(s => s.name.toLowerCase() === name.toLowerCase());
      if (existing) {
        if (!existing.active) {
          existing.active = true;
          addedCount++;
        }
      } else {
        const id = name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now() + Math.random();
        newSymptoms.push({ id, name, active: true });
        addedCount++;
      }
    });

    setSymptoms(newSymptoms);
    setBulkSymptomInput('');
    setLastAction(`Added ${addedCount} symptom${addedCount !== 1 ? 's' : ''}`);
  };

  const removeSymptom = (symptomId) => {
    setSymptoms(symptoms.map(s => 
      s.id === symptomId ? { ...s, active: false } : s
    ));
    setLastAction('Symptom hidden (history preserved)');
  };

  const reactivateSymptom = (symptomId) => {
    setSymptoms(symptoms.map(s => 
      s.id === symptomId ? { ...s, active: true } : s
    ));
    setLastAction('Symptom restored');
  };

  const startEditingSymptom = (symptom) => {
    setEditingSymptomId(symptom.id);
    setEditingSymptomName(symptom.name);
  };

  const saveSymptomName = () => {
    if (editingSymptomName.trim() && editingSymptomId) {
      setSymptoms(symptoms.map(s => 
        s.id === editingSymptomId ? { ...s, name: editingSymptomName.trim() } : s
      ));
      setLastAction('Symptom renamed');
    }
    setEditingSymptomId(null);
    setEditingSymptomName('');
  };

  const cancelEditingSymptom = () => {
    setEditingSymptomId(null);
    setEditingSymptomName('');
  };

  const clearEntry = (symptomId, timeId) => {
    const dateKey = getDateKey(selectedDate);
    const key = `${dateKey}-${symptomId}-${timeId}`;
    const newEntries = { ...entries };
    delete newEntries[key];
    setEntries(newEntries);
    setLastAction('Entry cleared');
  };

  const getCalendarDays = () => {
    const year = calendarMonth.getFullYear();
    const month = calendarMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDay = firstDay.getDay();
    
    const days = [];
    for (let i = 0; i < startingDay; i++) {
      days.push(null);
    }
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(new Date(year, month, i));
    }
    return days;
  };

  const getSortedHistory = () => {
    const history = Object.entries(entries).map(([key, value]) => ({
      ...value,
      key,
      symptomName: symptoms.find(s => s.id === value.symptomId)?.name || value.symptomId,
      timePeriodLabel: timePeriods.find(t => t.id === value.time)?.label || value.time,
    }));

    return history.sort((a, b) => {
      let comparison = 0;
      
      switch (historySort.column) {
        case 'date':
          comparison = a.date.localeCompare(b.date);
          break;
        case 'symptom':
          comparison = a.symptomName.localeCompare(b.symptomName);
          break;
        case 'time':
          const timeOrder = { night: 0, morning: 1, allday: 2, midday: 3, evening: 4 };
          comparison = (timeOrder[a.time] || 0) - (timeOrder[b.time] || 0);
          break;
        case 'severity':
          comparison = a.severity - b.severity;
          break;
        default:
          comparison = 0;
      }
      
      return historySort.direction === 'asc' ? comparison : -comparison;
    });
  };

  const toggleSort = (column) => {
    if (historySort.column === column) {
      setHistorySort({
        column,
        direction: historySort.direction === 'asc' ? 'desc' : 'asc'
      });
    } else {
      setHistorySort({ column, direction: 'desc' });
    }
  };

  const getSortIndicator = (column) => {
    if (historySort.column !== column) return '';
    return historySort.direction === 'asc' ? ' ↑' : ' ↓';
  };

  const getInsights = (windowDays = 60) => {
    const today = new Date();
    const entryList = Object.values(entries);
    
    // Need at least some data for meaningful insights
    const oldestEntry = entryList.reduce((min, e) => e.date < min ? e.date : min, entryList[0]?.date || '');
    const daysOfData = oldestEntry ? Math.floor((today - new Date(oldestEntry)) / (1000 * 60 * 60 * 24)) : 0;
    
    const minDaysNeeded = Math.floor(windowDays * 1.5);
    if (entryList.length < 20 || daysOfData < minDaysNeeded) {
      return { hasEnoughData: false, daysOfData, entriesCount: entryList.length, minDaysNeeded };
    }
    
    // Group entries by symptom
    const bySymptom = {};
    entryList.forEach(entry => {
      if (!bySymptom[entry.symptomId]) bySymptom[entry.symptomId] = [];
      bySymptom[entry.symptomId].push(entry);
    });
    
    const insights = [];
    
    // Calculate trends: last windowDays vs prior windowDays
    Object.entries(bySymptom).forEach(([symptomId, symptomEntries]) => {
      const symptom = symptoms.find(s => s.id === symptomId);
      if (!symptom) return;
      
      const recentEntries = symptomEntries.filter(e => {
        const daysAgo = Math.floor((today - new Date(e.date)) / (1000 * 60 * 60 * 24));
        return daysAgo <= windowDays;
      });
      const earlierEntries = symptomEntries.filter(e => {
        const daysAgo = Math.floor((today - new Date(e.date)) / (1000 * 60 * 60 * 24));
        return daysAgo > windowDays && daysAgo <= windowDays * 2;
      });
      
      // Need enough data in both periods
      if (recentEntries.length < 3 || earlierEntries.length < 3) return;
      
      const recentAvg = recentEntries.reduce((sum, e) => sum + e.severity, 0) / recentEntries.length;
      const earlierAvg = earlierEntries.reduce((sum, e) => sum + e.severity, 0) / earlierEntries.length;
      
      // Only show if there's meaningful change (>20%)
      if (earlierAvg === 0) return;
      const percentChange = Math.round(((recentAvg - earlierAvg) / earlierAvg) * 100);
      
      if (Math.abs(percentChange) >= 20) {
        insights.push({
          symptomId,
          name: symptom.name,
          percentChange,
          direction: percentChange < 0 ? 'improving' : 'worsening',
          recentAvg: recentAvg.toFixed(1),
          earlierAvg: earlierAvg.toFixed(1),
        });
      }
    });
    
    // Sort by absolute percent change (biggest changes first)
    insights.sort((a, b) => Math.abs(b.percentChange) - Math.abs(a.percentChange));
    
    // Find most common symptom cluster (symptoms appearing together)
    const dateGroups = {};
    entryList.forEach(entry => {
      if (!dateGroups[entry.date]) dateGroups[entry.date] = new Set();
      dateGroups[entry.date].add(entry.symptomId);
    });
    
    const coOccurrence = {};
    Object.values(dateGroups).forEach(symptomSet => {
      const symptomArray = Array.from(symptomSet);
      for (let i = 0; i < symptomArray.length; i++) {
        for (let j = i + 1; j < symptomArray.length; j++) {
          const key = [symptomArray[i], symptomArray[j]].sort().join('|');
          coOccurrence[key] = (coOccurrence[key] || 0) + 1;
        }
      }
    });
    
    // Only show cluster if it appears frequently (>30% of days)
    const totalDays = Object.keys(dateGroups).length;
    const topCluster = Object.entries(coOccurrence)
      .map(([pair, count]) => {
        const [id1, id2] = pair.split('|');
        const name1 = symptoms.find(s => s.id === id1)?.name || id1;
        const name2 = symptoms.find(s => s.id === id2)?.name || id2;
        return { names: [name1, name2], count, percent: Math.round((count / totalDays) * 100) };
      })
      .filter(c => c.percent >= 30)
      .sort((a, b) => b.count - a.count)[0] || null;
    
    // Generate simplified AI prompt
    const aiPrompt = generateAIPrompt(insights, topCluster, daysOfData, windowDays);
    
    return {
      hasEnoughData: true,
      insights: insights.slice(0, 5), // Top 5 only
      topCluster,
      daysOfData,
      entriesCount: entryList.length,
      aiPrompt,
      windowDays,
    };
  };

  const generateAIPrompt = (insights, topCluster, daysOfData, windowDays) => {
    let prompt = `Analyze my symptom tracking data. Be cautious and avoid prescriptive medical advice.\n\n`;
    
    if (insights.length > 0) {
      prompt += `Significant changes (last ${windowDays} days vs prior ${windowDays} days):\n`;
      insights.forEach(i => {
        prompt += `• ${i.name}: ${i.percentChange > 0 ? '+' : ''}${i.percentChange}% (${i.direction})\n`;
      });
    }
    
    if (topCluster) {
      prompt += `\nFrequent co-occurrence (${topCluster.percent}% of days):\n`;
      prompt += `• "${topCluster.names[0]}" often appears with "${topCluster.names[1]}"\n`;
    }
    
    // Add last 60 days of raw data
    const sixtyDaysAgo = new Date();
    sixtyDaysAgo.setDate(sixtyDaysAgo.getDate() - 60);
    
    const recentEntries = Object.values(entries)
      .filter(e => new Date(e.date) >= sixtyDaysAgo)
      .sort((a, b) => b.date.localeCompare(a.date));
    
    if (recentEntries.length > 0) {
      prompt += `\n\n--- RAW DATA (Last 60 days) ---\n`;
      prompt += `Date,Symptom,Time,Severity\n`;
      recentEntries.forEach(e => {
        const symptomName = symptoms.find(s => s.id === e.symptomId)?.name || e.symptomId;
        const timePeriod = timePeriods.find(t => t.id === e.time)?.label || e.time;
        prompt += `${e.date},${symptomName},${timePeriod},${e.severity}\n`;
      });
    }
    
    // Add stack data for last 60 days
    const recentStackEntries = Object.values(stackEntries)
      .filter(e => {
        const entryDate = new Date(e.date);
        return entryDate >= sixtyDaysAgo;
      })
      .sort((a, b) => b.date.localeCompare(a.date));
    
    if (recentStackEntries.length > 0) {
      prompt += `\n--- SUPPLEMENT DATA (Last 60 days) ---\n`;
      prompt += `Date,Supplement,Dose,Taken\n`;
      recentStackEntries.forEach(e => {
        const item = stackItems.find(i => i.id === e.itemId);
        if (item) {
          prompt += `${e.date},${item.name},${e.dose}${item.unit},${e.taken ? 'yes' : 'no'}\n`;
        }
      });
    }
    
    prompt += `\n--- END DATA ---\n\nPlease identify potential patterns, correlations between symptoms and supplements, and what might be worth discussing with a healthcare provider.`;
    
    return prompt;
  };

  // Generate AI-ready data export for a specific number of days
  const generateAIDataExport = (days) => {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - days);
    
    let prompt = `Analyze my health tracking data from the last ${days} days. Be cautious and avoid prescriptive medical advice.\n\n`;
    
    // Symptom data
    const recentEntries = Object.values(entries)
      .filter(e => new Date(e.date) >= cutoffDate)
      .sort((a, b) => b.date.localeCompare(a.date));
    
    if (recentEntries.length > 0) {
      prompt += `--- SYMPTOM DATA (Last ${days} days) ---\n`;
      prompt += `Date,Symptom,Time,Severity (0-5)\n`;
      recentEntries.forEach(e => {
        const symptomName = symptoms.find(s => s.id === e.symptomId)?.name || e.symptomId;
        const timePeriod = timePeriods.find(t => t.id === e.time)?.label || e.time;
        prompt += `${e.date},${symptomName},${timePeriod},${e.severity}\n`;
      });
    } else {
      prompt += `No symptom data in the last ${days} days.\n`;
    }
    
    // Supplement data
    const recentStackEntries = Object.values(stackEntries)
      .filter(e => new Date(e.date) >= cutoffDate)
      .sort((a, b) => b.date.localeCompare(a.date));
    
    if (recentStackEntries.length > 0) {
      prompt += `\n--- SUPPLEMENT DATA (Last ${days} days) ---\n`;
      prompt += `Date,Supplement,Dose,Taken\n`;
      recentStackEntries.forEach(e => {
        const item = stackItems.find(i => i.id === e.itemId);
        if (item) {
          prompt += `${e.date},${item.name},${e.dose}${item.unit},${e.taken ? 'yes' : 'no'}\n`;
        }
      });
    } else {
      prompt += `\nNo supplement data in the last ${days} days.\n`;
    }
    
    prompt += `\n--- END DATA ---\n\nPlease identify potential patterns, correlations between symptoms and supplements, and what might be worth discussing with a healthcare provider.`;
    
    return prompt;
  };

  const copyAIData = (days) => {
    const data = generateAIDataExport(days);
    navigator.clipboard.writeText(data);
    closeExport();
    setLastAction(`Copied ${days} days for AI analysis`);
  };

  const exportCSV = (days) => {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);
    
    const rows = [['Date', 'Symptom', 'Time Period', 'Severity', 'Severity Label']];
    
    Object.entries(entries).forEach(([key, entry]) => {
      const entryDate = new Date(entry.date);
      if (entryDate >= startDate && entryDate <= endDate) {
        const symptomName = symptoms.find(s => s.id === entry.symptomId)?.name || entry.symptomId;
        const timePeriod = timePeriods.find(t => t.id === entry.time)?.label || entry.time;
        rows.push([entry.date, symptomName, timePeriod, entry.severity, severityLabels[entry.severity]]);
      }
    });
    
    rows.sort((a, b) => {
      if (a[0] === 'Date') return -1;
      if (b[0] === 'Date') return 1;
      return b[0].localeCompare(a[0]);
    });
    
    const csv = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `symptoms-${days}days-${getDateKey(new Date())}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    closeExport();
    setLastAction(`Exported ${rows.length - 1} entries`);
  };

  const daysWithEntries = getDaysWithEntries();
  const activeSymptoms = symptoms.filter(s => s.active);
  const inactiveSymptoms = symptoms.filter(s => !s.active);
  const sortedHistory = getSortedHistory();
  const currentSymptomName = symptoms.find(s => s.id === activeSymptom)?.name || '';

  const tableHeaderStyle = {
    padding: '12px 8px',
    textAlign: 'left',
    color: '#94a3b8',
    fontSize: '11px',
    fontWeight: '600',
    textTransform: 'uppercase',
    letterSpacing: '0.5px',
    cursor: 'pointer',
    borderBottom: '2px solid rgba(99, 102, 241, 0.3)',
    whiteSpace: 'nowrap',
    userSelect: 'none',
  };

  const tableCellStyle = {
    padding: '10px 8px',
    fontSize: '13px',
    borderBottom: '1px solid rgba(99, 102, 241, 0.1)',
  };

  return (
    <div 
      ref={containerRef}
      onMouseMove={handleMouseMove}
      onMouseUp={handleEnd}
      onMouseLeave={handleEnd}
      onTouchMove={handleTouchMove}
      onTouchEnd={handleEnd}
      style={{
        height: '100dvh',
        minHeight: '100vh',
        background: 'linear-gradient(180deg, #0c0a1d 0%, #1a1333 100%)',
        fontFamily: "'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif",
        userSelect: 'none',
        WebkitUserSelect: 'none',
        WebkitTouchCallout: 'none',
        display: 'flex',
        flexDirection: 'column',
        overflow: 'hidden',
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
      }}
    >
      {/* Fixed Header Area */}
      <div style={{
        flexShrink: 0,
        padding: '16px 16px 24px',
        background: 'linear-gradient(180deg, #0c0a1d 0%, #1a1333 100%)',
        zIndex: 100,
      }}>
        {/* Date Navigation Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }}>
        <button
          onClick={() => changeDate(-1)}
          style={{
            background: 'rgba(99, 102, 241, 0.15)',
            border: '1px solid rgba(99, 102, 241, 0.3)',
            borderRadius: '10px',
            width: '36px',
            height: '36px',
            color: '#a5b4fc',
            fontSize: '18px',
            cursor: 'pointer',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
          }}
        >
          ‹
        </button>
        
        <button
          onClick={() => {
            setCalendarMonth(new Date(selectedDate));
            setShowCalendar(true);
          }}
          style={{
            background: 'transparent',
            border: 'none',
            cursor: 'pointer',
            textAlign: 'center',
            padding: '2px 8px',
          }}
        >
          <h1 style={{
            color: '#f8fafc',
            fontSize: '18px',
            fontWeight: '700',
            margin: 0,
            display: 'flex',
            alignItems: 'baseline',
            justifyContent: 'center',
            gap: '6px',
          }}>
            {formatDate(selectedDate)}
            <span style={{
              fontSize: '9px',
              color: '#64748b',
              fontWeight: '400',
            }}>v1.5</span>
          </h1>
        </button>

        <button
          onClick={() => changeDate(1)}
          disabled={!canGoForward()}
          style={{
            background: canGoForward() ? 'rgba(99, 102, 241, 0.15)' : 'rgba(50, 50, 70, 0.3)',
            border: '1px solid rgba(99, 102, 241, 0.3)',
            borderRadius: '10px',
            width: '36px',
            height: '36px',
            color: canGoForward() ? '#a5b4fc' : '#475569',
            fontSize: '18px',
            cursor: canGoForward() ? 'pointer' : 'default',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            opacity: canGoForward() ? 1 : 0.5,
          }}
        >
          ›
        </button>
      </div>
      </div>

      {/* Scrollable Content Area */}
      <div style={{
        flex: 1,
        overflowY: 'auto',
        overflowX: 'hidden',
        padding: '16px 16px 120px 16px',
        WebkitOverflowScrolling: 'touch',
      }}>
        {appMode === 'symptoms' ? (
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
        }}>
        {activeSymptoms.map((symptom) => {
          const symptomEntries = getSymptomEntries(symptom.id);
          const isActive = activeSymptom === symptom.id;
          
          return (
            <div
              key={symptom.id}
              onTouchStart={(e) => handleTouchStart(e, symptom.id)}
              onMouseDown={(e) => handleMouseDown(e, symptom.id)}
              style={{
                background: isActive 
                  ? 'rgba(99, 102, 241, 0.15)' 
                  : 'rgba(30, 27, 75, 0.6)',
                borderRadius: '14px',
                padding: '14px 16px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                border: isActive 
                  ? '2px solid rgba(99, 102, 241, 0.5)' 
                  : '2px solid transparent',
                cursor: 'pointer',
                transition: 'all 0.15s ease',
                transform: isActive ? 'scale(1.02)' : 'scale(1)',
              }}
            >
              <span style={{
                color: '#e2e8f0',
                fontSize: '16px',
                fontWeight: '600',
              }}>{symptom.name}</span>
              
              <div style={{
                display: 'flex',
                gap: '4px',
                justifyContent: 'flex-end',
                minWidth: trackingMode === 'simple' ? '50px' : trackingMode === 'ampm' ? '100px' : '180px',
              }}>
                {symptomEntries.length === 0 ? (
                  <span style={{ color: '#475569', fontSize: '12px' }}>
                    Hold to log
                  </span>
                ) : (
                  timePeriods.map((period) => {
                    const entry = symptomEntries.find(e => e.time === period.id);
                    if (!entry) {
                      return (
                        <div key={period.id} style={{ width: '44px' }} />
                      );
                    }
                    return (
                    <div 
                      key={period.id} 
                      onClick={(e) => {
                        e.stopPropagation();
                        clearEntry(symptom.id, entry.time);
                      }}
                      style={{
                        background: 'rgba(30, 27, 75, 0.6)',
                        border: `1px solid ${severityColors[entry.severity]}4D`,
                        borderRadius: '6px',
                        padding: '4px 8px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '4px',
                        cursor: 'pointer',
                        width: '44px',
                        justifyContent: 'center',
                      }}
                    >
                      <span style={{
                        fontSize: '12px',
                        color: '#94a3b8',
                      }}>
                        {period.icon}
                      </span>
                      <span style={{
                        color: severityColors[entry.severity],
                        fontSize: '13px',
                        fontWeight: '700',
                      }}>{entry.severity}</span>
                    </div>
                  );})
                )}
              </div>
            </div>
          );
        })}

        <button
          onClick={() => setShowAddSymptom(true)}
          style={{
            background: 'transparent',
            border: '2px dashed rgba(99, 102, 241, 0.3)',
            borderRadius: '14px',
            padding: '16px',
            color: '#6366f1',
            fontSize: '15px',
            fontWeight: '500',
            cursor: 'pointer',
            marginTop: '4px',
          }}
        >
          + Add Symptoms
        </button>
        </div>
        ) : (
        /* Stack Mode */
        <div style={{
          display: 'flex',
          flexDirection: 'column',
          gap: '8px',
        }}>
          {/* Progress indicator and actions */}
          {stackItems.filter(i => i.active).length > 0 && (
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '8px',
            }}>
              <button
                onClick={() => {
                  const dateKey = getDateKey(selectedDate);
                  const newEntries = { ...stackEntries };
                  stackItems.filter(i => i.active).forEach(item => {
                    const entryKey = `${dateKey}-${item.id}`;
                    newEntries[entryKey] = {
                      date: dateKey,
                      itemId: item.id,
                      dose: item.defaultDose,
                      taken: true
                    };
                  });
                  setStackEntries(newEntries);
                  setLastAction('All selected');
                }}
                style={{
                  background: 'transparent',
                  border: 'none',
                  color: '#4ade80',
                  fontSize: '12px',
                  cursor: 'pointer',
                  padding: '4px 8px',
                }}
              >
                Select All
              </button>
              <span style={{ color: '#94a3b8', fontSize: '13px' }}>
                {getStackProgress().taken} / {getStackProgress().total}
              </span>
              <button
                onClick={() => {
                  const dateKey = getDateKey(selectedDate);
                  const newEntries = { ...stackEntries };
                  Object.keys(newEntries).forEach(key => {
                    if (key.startsWith(dateKey)) {
                      delete newEntries[key];
                    }
                  });
                  setStackEntries(newEntries);
                  setLastAction('All deselected');
                }}
                style={{
                  background: 'transparent',
                  border: 'none',
                  color: '#f87171',
                  fontSize: '12px',
                  cursor: 'pointer',
                  padding: '4px 8px',
                }}
              >
                Clear All
              </button>
            </div>
          )}

          {stackItems.filter(i => i.active).sort((a, b) => (a.order || 0) - (b.order || 0)).map((item) => {
            const entry = getStackEntry(item.id);
            const isTaken = !!entry;
            const isEditing = editingStackItem === item.id;
            
            return (
              <div
                key={item.id}
                style={{
                  background: isTaken 
                    ? 'rgba(34, 197, 94, 0.1)' 
                    : 'rgba(30, 27, 75, 0.6)',
                  borderRadius: '14px',
                  padding: '14px 16px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  border: isTaken 
                    ? '1px solid rgba(34, 197, 94, 0.3)' 
                    : '1px solid transparent',
                  cursor: 'pointer',
                  transition: 'all 0.15s ease',
                }}
                onClick={() => !isEditing && toggleStackItem(item.id)}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flex: 1 }}>
                  <div style={{
                    width: '24px',
                    height: '24px',
                    borderRadius: '6px',
                    background: isTaken ? '#22c55e' : 'rgba(100, 116, 139, 0.3)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    color: isTaken ? '#fff' : '#64748b',
                    fontSize: '14px',
                    fontWeight: '700',
                    flexShrink: 0,
                  }}>
                    {isTaken ? '✓' : ''}
                  </div>
                  <span style={{
                    color: isTaken ? '#e2e8f0' : '#94a3b8',
                    fontSize: '15px',
                    fontWeight: '500',
                  }}>{item.name}</span>
                </div>
                
                {isEditing ? (
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}
                       onClick={(e) => e.stopPropagation()}>
                    <input
                      type="text"
                      inputMode="decimal"
                      defaultValue={entry?.dose || item.defaultDose}
                      autoFocus
                      style={{
                        width: '60px',
                        background: 'rgba(99, 102, 241, 0.15)',
                        border: '2px solid rgba(99, 102, 241, 0.5)',
                        borderRadius: '8px',
                        padding: '8px 10px',
                        color: '#f8fafc',
                        fontSize: '16px',
                        fontWeight: '600',
                        textAlign: 'center',
                        outline: 'none',
                      }}
                      onFocus={(e) => e.target.select()}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          updateStackDose(item.id, e.target.value);
                        } else if (e.key === 'Escape') {
                          setEditingStackItem(null);
                        }
                      }}
                      onBlur={(e) => updateStackDose(item.id, e.target.value)}
                    />
                    <span style={{ color: '#94a3b8', fontSize: '13px', fontWeight: '500' }}>{item.unit}</span>
                  </div>
                ) : (
                  <div 
                    style={{ 
                      display: 'flex', 
                      alignItems: 'baseline', 
                      gap: '4px',
                      padding: '4px 8px',
                      borderRadius: '6px',
                      background: isTaken ? 'rgba(34, 197, 94, 0.15)' : 'transparent',
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setEditingStackItem(item.id);
                    }}
                  >
                    <span style={{
                      color: isTaken ? '#4ade80' : '#64748b',
                      fontSize: '15px',
                      fontWeight: '600',
                    }}>
                      {entry?.dose || item.defaultDose}
                    </span>
                    <span style={{
                      color: isTaken ? '#4ade80' : '#64748b',
                      fontSize: '11px',
                    }}>
                      {item.unit}
                    </span>
                  </div>
                )}
              </div>
            );
          })}

          <button
            onClick={() => setShowManageStack(true)}
            style={{
              background: 'transparent',
              border: '2px dashed rgba(99, 102, 241, 0.3)',
              borderRadius: '14px',
              padding: '16px',
              color: '#6366f1',
              fontSize: '15px',
              fontWeight: '500',
              cursor: 'pointer',
              marginTop: '4px',
            }}
          >
            + Manage Stack
          </button>
        </div>
        )}
      </div>

      {/* Bottom Tab Bar */}
      <div style={{
        position: 'fixed',
        bottom: 0,
        left: 0,
        right: 0,
        background: 'linear-gradient(180deg, rgba(12, 10, 29, 0.95) 0%, #0c0a1d 100%)',
        borderTop: '1px solid rgba(99, 102, 241, 0.2)',
        display: 'flex',
        padding: '8px 16px',
        paddingBottom: 'max(8px, env(safe-area-inset-bottom))',
        zIndex: 200,
      }}>
        <button
          onClick={() => { setAppMode('symptoms'); setShowInsights(false); setShowSettings(false); }}
          style={{
            flex: 1,
            background: appMode === 'symptoms' && !showInsights && !showSettings ? 'rgba(99, 102, 241, 0.15)' : 'transparent',
            border: 'none',
            borderRadius: '12px',
            padding: '12px 8px',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '4px',
          }}
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={appMode === 'symptoms' && !showInsights && !showSettings ? '#a5b4fc' : '#64748b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          <span style={{
            color: appMode === 'symptoms' && !showInsights && !showSettings ? '#a5b4fc' : '#64748b',
            fontSize: '11px',
            fontWeight: appMode === 'symptoms' && !showInsights && !showSettings ? '600' : '400',
          }}>Symptoms</span>
        </button>
        <button
          onClick={() => { setAppMode('stack'); setShowInsights(false); setShowSettings(false); }}
          style={{
            flex: 1,
            background: appMode === 'stack' && !showInsights && !showSettings ? 'rgba(99, 102, 241, 0.15)' : 'transparent',
            border: 'none',
            borderRadius: '12px',
            padding: '12px 8px',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '4px',
          }}
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={appMode === 'stack' && !showInsights && !showSettings ? '#a5b4fc' : '#64748b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M10.5 20.5L3.5 13.5a4.95 4.95 0 1 1 7-7l7 7a4.95 4.95 0 1 1-7 7z"/>
            <line x1="8.5" y1="8.5" x2="15.5" y2="15.5"/>
          </svg>
          <span style={{
            color: appMode === 'stack' && !showInsights && !showSettings ? '#a5b4fc' : '#64748b',
            fontSize: '11px',
            fontWeight: appMode === 'stack' && !showInsights && !showSettings ? '600' : '400',
          }}>Stack</span>
        </button>
        <button
          onClick={() => { setShowInsights(true); setShowSettings(false); }}
          style={{
            flex: 1,
            background: showInsights ? 'rgba(99, 102, 241, 0.15)' : 'transparent',
            border: 'none',
            borderRadius: '12px',
            padding: '12px 8px',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '4px',
          }}
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={showInsights ? '#a5b4fc' : '#64748b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <line x1="18" y1="20" x2="18" y2="10"/>
            <line x1="12" y1="20" x2="12" y2="4"/>
            <line x1="6" y1="20" x2="6" y2="14"/>
          </svg>
          <span style={{
            color: showInsights ? '#a5b4fc' : '#64748b',
            fontSize: '11px',
            fontWeight: showInsights ? '600' : '400',
          }}>Insights</span>
        </button>
        <button
          onClick={() => { setShowSettings(true); setShowInsights(false); }}
          style={{
            flex: 1,
            background: showSettings ? 'rgba(99, 102, 241, 0.15)' : 'transparent',
            border: 'none',
            borderRadius: '12px',
            padding: '12px 8px',
            cursor: 'pointer',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '4px',
          }}
        >
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={showSettings ? '#a5b4fc' : '#64748b'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
          <span style={{
            color: showSettings ? '#a5b4fc' : '#64748b',
            fontSize: '11px',
            fontWeight: showSettings ? '600' : '400',
          }}>Settings</span>
        </button>
      </div>

      {/* 2D Drag Picker Overlay - Simplified Full Screen */}
      {isDragging && activeSymptom && (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: '#0a1628',
          display: 'flex',
          flexDirection: 'column',
          zIndex: 1000,
          touchAction: 'none',
        }}>
          {/* Severity color bar at very top */}
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            height: '5px',
            background: severityColors[dragPosition.y],
            zIndex: 1002,
            transition: 'background 0.1s ease',
          }} />

          {/* Screen zone indicators - 5 vertical sections */}
          <div style={{
            position: 'absolute',
            inset: 0,
            display: 'flex',
            pointerEvents: 'none',
          }}>
            {timePeriods.map((period, idx) => (
              <div 
                key={period.id}
                style={{
                  flex: 1,
                  borderRight: idx < 4 ? '1px solid rgba(99, 102, 241, 0.15)' : 'none',
                  background: dragPosition.x === idx ? 'rgba(99, 102, 241, 0.08)' : 'transparent',
                  transition: 'background 0.1s ease',
                }}
              />
            ))}
          </div>

          {/* Top zone - Time period icons (hidden in simple mode) */}
          {trackingMode !== 'simple' && (
            <div style={{
              position: 'fixed',
              top: 5,
              left: 0,
              right: 0,
              display: 'flex',
              background: 'linear-gradient(180deg, #0a1628 0%, #0c1929 100%)',
            }}>
              {timePeriods.map((period, idx) => (
                <div 
                  key={period.id}
                  style={{
                    flex: 1,
                    padding: '24px 8px 16px',
                    textAlign: 'center',
                    background: dragPosition.x === idx ? 'rgba(99, 102, 241, 0.25)' : 'transparent',
                    borderRight: idx < timePeriods.length - 1 ? '1px solid rgba(99, 102, 241, 0.1)' : 'none',
                    transition: 'background 0.1s ease',
                  }}
                >
                  <div style={{
                    fontSize: '28px',
                    marginBottom: '4px',
                    opacity: dragPosition.x === idx ? 1 : 0.6,
                    transition: 'opacity 0.1s',
                    color: dragPosition.x === idx ? '#fff' : '#a5b4fc',
                  }}>
                    {period.icon}
                  </div>
                  <div style={{
                    fontSize: '11px',
                    color: dragPosition.x === idx ? '#fff' : '#94a3b8',
                    fontWeight: dragPosition.x === idx ? '700' : '500',
                    textTransform: 'uppercase',
                    letterSpacing: '0.5px',
                    transition: 'all 0.1s',
                  }}>
                    {period.label}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* Symptom Name - below time icons */}
          <div style={{
            paddingTop: trackingMode === 'simple' ? '40px' : '120px',
            textAlign: 'center',
          }}>
            <h1 style={{
              color: '#f8fafc',
              fontSize: '28px',
              fontWeight: '700',
              margin: 0,
              padding: '0 24px',
            }}>
              {currentSymptomName}
            </h1>
          </div>

          {/* Big Floating Number - Follows finger, stays below header */}
          {(() => {
            // Calculate horizontal offset for AM/PM mode to avoid finger
            let xOffset = 0;
            if (timePeriods.length === 2) {
              // AM/PM mode: offset away from finger
              xOffset = dragPosition.x === 0 ? 80 : -80; // AM=right offset, PM=left offset
            }
            const baseX = Math.max(60, Math.min(window.innerWidth - 60, fingerPosition.x + xOffset));
            
            return (
              <div style={{
                position: 'fixed',
                left: `${baseX}px`,
                top: `${Math.max(230, Math.min(window.innerHeight - 150, fingerPosition.y - 130))}px`,
                transform: 'translate(-50%, -50%)',
                pointerEvents: 'none',
                zIndex: 1001,
                textAlign: 'center',
              }}>
                <div style={{
                  fontSize: '120px',
                  fontWeight: '800',
                  color: severityColors[dragPosition.y],
                  textShadow: `0 0 30px ${severityColors[dragPosition.y]}80`,
                  lineHeight: 1,
                  transition: 'color 0.1s ease, text-shadow 0.1s ease',
                }}>
                  {dragPosition.y}
                </div>
                <div style={{
                  color: '#94a3b8',
                  fontSize: '14px',
                  fontWeight: '500',
                  marginTop: '8px',
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>
                  {severityLabels[dragPosition.y]}
                </div>
              </div>
            );
          })()}
        </div>
      )}

      {/* Calendar Modal */}
      {showCalendar && (
        <div 
          onClick={() => setShowCalendar(false)}
          style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(0, 0, 0, 0.92)',
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{
              background: '#1a1333',
              borderRadius: '20px',
              padding: '24px',
              width: '100%',
              maxWidth: '380px',
              border: '2px solid rgba(99, 102, 241, 0.3)',
            }}
          >
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '20px',
            }}>
              <button
                onClick={() => {
                  const newMonth = new Date(calendarMonth);
                  newMonth.setMonth(newMonth.getMonth() - 1);
                  setCalendarMonth(newMonth);
                }}
                style={{
                  background: 'rgba(99, 102, 241, 0.2)',
                  border: 'none',
                  borderRadius: '12px',
                  width: '52px',
                  height: '52px',
                  color: '#a5b4fc',
                  fontSize: '24px',
                  cursor: 'pointer',
                }}
              >
                ‹
              </button>
              
              <h2 style={{
                color: '#f8fafc',
                fontSize: '20px',
                fontWeight: '700',
                margin: 0,
              }}>
                {calendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
              </h2>
              
              <button
                onClick={() => {
                  const newMonth = new Date(calendarMonth);
                  newMonth.setMonth(newMonth.getMonth() + 1);
                  setCalendarMonth(newMonth);
                }}
                style={{
                  background: 'rgba(99, 102, 241, 0.2)',
                  border: 'none',
                  borderRadius: '12px',
                  width: '52px',
                  height: '52px',
                  color: '#a5b4fc',
                  fontSize: '24px',
                  cursor: 'pointer',
                }}
              >
                ›
              </button>
            </div>

            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(7, 1fr)',
              gap: '4px',
              marginBottom: '8px',
            }}>
              {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, idx) => (
                <div key={idx} style={{
                  textAlign: 'center',
                  color: '#64748b',
                  fontSize: '13px',
                  fontWeight: '600',
                  padding: '8px 0',
                }}>
                  {day}
                </div>
              ))}
            </div>

            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(7, 1fr)',
              gap: '4px',
            }}>
              {getCalendarDays().map((day, idx) => {
                if (!day) return <div key={idx} style={{ aspectRatio: '1' }} />;
                
                const dateKey = getDateKey(day);
                const hasEntries = daysWithEntries.has(dateKey);
                const isSelected = dateKey === getDateKey(selectedDate);
                const isToday = dateKey === getDateKey(new Date());
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const isFuture = day > today;
                
                return (
                  <button
                    key={idx}
                    onClick={() => !isFuture && selectDate(day)}
                    disabled={isFuture}
                    style={{
                      aspectRatio: '1',
                      borderRadius: '12px',
                      border: isSelected ? '2px solid #6366f1' : isToday ? '2px solid rgba(99, 102, 241, 0.4)' : '2px solid transparent',
                      background: isFuture ? 'rgba(30, 27, 75, 0.2)' : isSelected ? 'rgba(99, 102, 241, 0.3)' : hasEntries ? 'rgba(74, 222, 128, 0.15)' : 'rgba(30, 27, 75, 0.5)',
                      color: isFuture ? '#475569' : isSelected ? '#fff' : hasEntries ? '#4ade80' : '#94a3b8',
                      fontSize: '16px',
                      fontWeight: isSelected || isToday ? '700' : '500',
                      cursor: isFuture ? 'default' : 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      position: 'relative',
                      opacity: isFuture ? 0.4 : 1,
                    }}
                  >
                    {day.getDate()}
                    {hasEntries && !isSelected && !isFuture && (
                      <div style={{
                        position: 'absolute',
                        bottom: '6px',
                        width: '4px',
                        height: '4px',
                        borderRadius: '50%',
                        background: '#4ade80',
                      }} />
                    )}
                  </button>
                );
              })}
            </div>

            <button
              onClick={() => selectDate(new Date())}
              style={{
                width: '100%',
                marginTop: '16px',
                padding: '14px',
                background: 'rgba(99, 102, 241, 0.2)',
                border: '1px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '12px',
                color: '#a5b4fc',
                fontSize: '15px',
                fontWeight: '600',
                cursor: 'pointer',
              }}
            >
              Go to Today
            </button>
          </div>
        </div>
      )}

      {/* Add Symptom Modal */}
      {showAddSymptom && (
        <div 
          onClick={() => setShowAddSymptom(false)}
          style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(0, 0, 0, 0.92)',
            zIndex: 1000,
            overflowY: 'auto',
            padding: '20px',
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{ maxWidth: '400px', margin: '0 auto' }}
          >
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '20px',
            }}>
              <h2 style={{ color: '#f8fafc', fontSize: '22px', fontWeight: '700', margin: 0 }}>
                Add Symptoms
              </h2>
              <button
                onClick={() => setShowAddSymptom(false)}
                style={{
                  background: 'rgba(99, 102, 241, 0.2)',
                  border: 'none',
                  borderRadius: '10px',
                  width: '44px',
                  height: '44px',
                  color: '#a5b4fc',
                  fontSize: '20px',
                  cursor: 'pointer',
                }}
              >
                ✕
              </button>
            </div>

            <div style={{
              background: 'rgba(30, 27, 75, 0.6)',
              borderRadius: '12px',
              padding: '16px',
              marginBottom: '20px',
            }}>
              <label style={{
                color: '#94a3b8',
                fontSize: '12px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
              }}>Add Multiple Symptoms</label>
              <p style={{
                color: '#64748b',
                fontSize: '12px',
                margin: '4px 0 10px 0',
              }}>
                Paste or type symptoms separated by commas, tabs, or new lines
              </p>
              <textarea
                value={bulkSymptomInput}
                onChange={(e) => setBulkSymptomInput(e.target.value)}
                placeholder="Headache, Fatigue, Nausea&#10;Back Pain&#10;Insomnia, Anxiety"
                rows={4}
                style={{
                  width: '100%',
                  background: 'rgba(15, 23, 42, 0.8)',
                  border: '2px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '10px',
                  padding: '12px 14px',
                  color: '#f8fafc',
                  fontSize: '15px',
                  outline: 'none',
                  resize: 'vertical',
                  fontFamily: 'inherit',
                }}
              />
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '10px' }}>
                <span style={{ color: '#64748b', fontSize: '12px' }}>
                  {parseBulkSymptoms(bulkSymptomInput).length} symptom(s) detected
                </span>
                <button
                  onClick={addBulkSymptoms}
                  disabled={parseBulkSymptoms(bulkSymptomInput).length === 0}
                  style={{
                    background: parseBulkSymptoms(bulkSymptomInput).length > 0 ? '#6366f1' : 'rgba(99, 102, 241, 0.3)',
                    border: 'none',
                    borderRadius: '10px',
                    padding: '10px 20px',
                    color: '#fff',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: parseBulkSymptoms(bulkSymptomInput).length > 0 ? 'pointer' : 'not-allowed',
                  }}
                >
                  Add All
                </button>
              </div>
            </div>

            {activeSymptoms.length > 0 && (
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  color: '#94a3b8',
                  fontSize: '12px',
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>Active Symptoms</label>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  marginTop: '12px',
                }}>
                  {activeSymptoms.map((symptom) => (
                    <div
                      key={symptom.id}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                      }}
                    >
                      {editingSymptomId === symptom.id ? (
                        <div style={{
                          flex: 1,
                          display: 'flex',
                          gap: '8px',
                        }}>
                          <input
                            type="text"
                            value={editingSymptomName}
                            onChange={(e) => setEditingSymptomName(e.target.value)}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter') saveSymptomName();
                              if (e.key === 'Escape') cancelEditingSymptom();
                            }}
                            autoFocus
                            style={{
                              flex: 1,
                              background: 'rgba(99, 102, 241, 0.2)',
                              border: '2px solid rgba(99, 102, 241, 0.5)',
                              borderRadius: '8px',
                              padding: '10px 12px',
                              color: '#fff',
                              fontSize: '14px',
                              outline: 'none',
                            }}
                          />
                          <button
                            onClick={saveSymptomName}
                            style={{
                              background: 'rgba(74, 222, 128, 0.2)',
                              border: '2px solid rgba(74, 222, 128, 0.4)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#86efac',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✓
                          </button>
                          <button
                            onClick={cancelEditingSymptom}
                            style={{
                              background: 'rgba(239, 68, 68, 0.15)',
                              border: '2px solid rgba(239, 68, 68, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#fca5a5',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✕
                          </button>
                        </div>
                      ) : (
                        <>
                          <button
                            onClick={() => startEditingSymptom(symptom)}
                            style={{
                              background: 'rgba(99, 102, 241, 0.15)',
                              border: '2px solid rgba(99, 102, 241, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 12px',
                              color: '#a5b4fc',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✎
                          </button>
                          <span style={{
                            flex: 1,
                            color: '#e2e8f0',
                            fontSize: '14px',
                          }}>
                            {symptom.name}
                          </span>
                          <button
                            onClick={() => removeSymptom(symptom.id)}
                            style={{
                              background: 'rgba(239, 68, 68, 0.15)',
                              border: '2px solid rgba(239, 68, 68, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#fca5a5',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✕
                          </button>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {inactiveSymptoms.length > 0 && (
              <div>
                <label style={{
                  color: '#94a3b8',
                  fontSize: '12px',
                  textTransform: 'uppercase',
                  letterSpacing: '1px',
                }}>Hidden Symptoms</label>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  marginTop: '12px',
                }}>
                  {inactiveSymptoms.map((symptom) => (
                    <div
                      key={symptom.id}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                      }}
                    >
                      {editingSymptomId === symptom.id ? (
                        <div style={{
                          flex: 1,
                          display: 'flex',
                          gap: '8px',
                        }}>
                          <input
                            type="text"
                            value={editingSymptomName}
                            onChange={(e) => setEditingSymptomName(e.target.value)}
                            onKeyDown={(e) => {
                              if (e.key === 'Enter') saveSymptomName();
                              if (e.key === 'Escape') cancelEditingSymptom();
                            }}
                            autoFocus
                            style={{
                              flex: 1,
                              background: 'rgba(99, 102, 241, 0.2)',
                              border: '2px solid rgba(99, 102, 241, 0.5)',
                              borderRadius: '8px',
                              padding: '10px 12px',
                              color: '#fff',
                              fontSize: '14px',
                              outline: 'none',
                            }}
                          />
                          <button
                            onClick={saveSymptomName}
                            style={{
                              background: 'rgba(74, 222, 128, 0.2)',
                              border: '2px solid rgba(74, 222, 128, 0.4)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#86efac',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✓
                          </button>
                          <button
                            onClick={cancelEditingSymptom}
                            style={{
                              background: 'rgba(239, 68, 68, 0.15)',
                              border: '2px solid rgba(239, 68, 68, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#fca5a5',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✕
                          </button>
                        </div>
                      ) : (
                        <>
                          <button
                            onClick={() => startEditingSymptom(symptom)}
                            style={{
                              background: 'rgba(99, 102, 241, 0.15)',
                              border: '2px solid rgba(99, 102, 241, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 12px',
                              color: '#a5b4fc',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            ✎
                          </button>
                          <span style={{
                            flex: 1,
                            color: '#94a3b8',
                            fontSize: '14px',
                          }}>
                            {symptom.name}
                          </span>
                          <button
                            onClick={() => reactivateSymptom(symptom.id)}
                            style={{
                              background: 'rgba(74, 222, 128, 0.15)',
                              border: '2px solid rgba(74, 222, 128, 0.3)',
                              borderRadius: '8px',
                              padding: '10px 14px',
                              color: '#86efac',
                              fontSize: '14px',
                              cursor: 'pointer',
                            }}
                          >
                            +
                          </button>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      )}

      {/* History Modal with Sortable Table */}
      {showHistory && (
        <div 
          onClick={closeHistory}
          style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(0, 0, 0, 0.92)',
            zIndex: 1000,
            overflowY: 'auto',
            padding: '20px',
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{ maxWidth: '600px', margin: '0 auto' }}
          >
            {/* Header */}
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '16px',
              position: 'sticky',
              top: 0,
              background: 'rgba(12, 10, 29, 0.98)',
              padding: '10px 0',
              zIndex: 10,
            }}>
              <div>
                <h2 style={{ color: '#f8fafc', fontSize: '22px', fontWeight: '700', margin: 0 }}>
                  History
                </h2>
                <p style={{ color: '#64748b', fontSize: '12px', margin: '4px 0 0 0' }}>
                  {sortedHistory.length} entries • Tap column headers to sort
                </p>
              </div>
              <button
                onClick={closeHistory}
                style={{
                  background: 'rgba(99, 102, 241, 0.2)',
                  border: 'none',
                  borderRadius: '10px',
                  width: '44px',
                  height: '44px',
                  color: '#a5b4fc',
                  fontSize: '20px',
                  cursor: 'pointer',
                }}
              >
                ✕
              </button>
            </div>

            {sortedHistory.length === 0 ? (
              <p style={{ color: '#64748b', textAlign: 'center', padding: '40px 0' }}>
                No entries recorded yet
              </p>
            ) : (
              <div style={{
                background: 'rgba(30, 27, 75, 0.5)',
                borderRadius: '12px',
                overflow: 'hidden',
                border: '1px solid rgba(99, 102, 241, 0.2)',
              }}>
                <table style={{
                  width: '100%',
                  borderCollapse: 'collapse',
                }}>
                  <thead>
                    <tr style={{ background: 'rgba(30, 27, 75, 0.8)' }}>
                      <th 
                        onClick={() => toggleSort('date')}
                        style={tableHeaderStyle}
                      >
                        Date{getSortIndicator('date')}
                      </th>
                      <th 
                        onClick={() => toggleSort('symptom')}
                        style={tableHeaderStyle}
                      >
                        Symptom{getSortIndicator('symptom')}
                      </th>
                      <th 
                        onClick={() => toggleSort('time')}
                        style={tableHeaderStyle}
                      >
                        Time{getSortIndicator('time')}
                      </th>
                      <th 
                        onClick={() => toggleSort('severity')}
                        style={{...tableHeaderStyle, textAlign: 'center'}}
                      >
                        Severity{getSortIndicator('severity')}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {sortedHistory.map((entry, idx) => (
                      <tr 
                        key={entry.key}
                        style={{
                          background: idx % 2 === 0 ? 'transparent' : 'rgba(99, 102, 241, 0.03)',
                        }}
                      >
                        <td style={{...tableCellStyle, color: '#94a3b8', whiteSpace: 'nowrap'}}>
                          {formatTableDate(entry.date)}
                        </td>
                        <td style={{...tableCellStyle, color: '#e2e8f0', fontWeight: '500'}}>
                          {entry.symptomName}
                        </td>
                        <td style={{...tableCellStyle, color: '#94a3b8'}}>
                          <span style={{ marginRight: '6px', color: '#a5b4fc' }}>
                            {timePeriods.find(t => t.id === entry.time)?.icon}
                          </span>
                          {entry.timePeriodLabel}
                        </td>
                        <td style={{...tableCellStyle, textAlign: 'center'}}>
                          <span style={{
                            display: 'inline-block',
                            minWidth: '28px',
                            padding: '4px 8px',
                            borderRadius: '6px',
                            background: `${severityColors[entry.severity]}20`,
                            color: severityColors[entry.severity],
                            fontWeight: '700',
                            fontSize: '13px',
                          }}>
                            {entry.severity}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      )}

      {/* Export Modal */}
      {showExport && (
        <div 
          onClick={closeExport}
          style={{
            position: 'fixed',
            inset: 0,
            background: 'rgba(0, 0, 0, 0.92)',
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
          }}
        >
          <div 
            onClick={(e) => e.stopPropagation()}
            style={{
              background: '#1a1333',
              borderRadius: '20px',
              padding: '24px',
              width: '100%',
              maxWidth: '320px',
              maxHeight: '80vh',
              overflowY: 'auto',
              border: '2px solid rgba(99, 102, 241, 0.3)',
            }}
          >
            <h2 style={{
              color: '#f8fafc',
              fontSize: '20px',
              fontWeight: '700',
              margin: '0 0 16px 0',
              textAlign: 'center',
            }}>
              Export
            </h2>
            
            {/* Copy for AI Section */}
            <div style={{ marginBottom: '20px' }}>
              <label style={{
                color: '#94a3b8',
                fontSize: '11px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
                display: 'block',
                marginBottom: '10px',
              }}>Copy for AI Analysis</label>
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                {[
                  { label: '7 days', days: 7 },
                  { label: '14 days', days: 14 },
                  { label: '30 days', days: 30 },
                  { label: '60 days', days: 60 },
                ].map(({ label, days }) => (
                  <button
                    key={days}
                    onClick={() => copyAIData(days)}
                    style={{
                      background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.15) 100%)',
                      border: '1px solid rgba(139, 92, 246, 0.4)',
                      borderRadius: '10px',
                      padding: '12px',
                      color: '#c4b5fd',
                      fontSize: '13px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      textAlign: 'center',
                    }}
                  >
                    🤖 {label}
                  </button>
                ))}
              </div>
              <p style={{ 
                color: '#64748b', 
                fontSize: '11px', 
                margin: '8px 0 0 0',
                textAlign: 'center',
              }}>
                Copies symptoms + supplements data
              </p>
            </div>
            
            {/* CSV Export Section */}
            <div>
              <label style={{
                color: '#94a3b8',
                fontSize: '11px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
                display: 'block',
                marginBottom: '10px',
              }}>Download CSV</label>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {[
                  { label: 'Last 7 days', days: 7 },
                  { label: 'Last 30 days', days: 30 },
                  { label: 'Last 3 months', days: 90 },
                  { label: 'Last 6 months', days: 180 },
                  { label: 'Last 12 months', days: 365 },
                  { label: 'All time', days: 99999 },
                ].map(({ label, days }) => (
                  <button
                    key={days}
                    onClick={() => exportCSV(days)}
                    style={{
                      background: 'rgba(99, 102, 241, 0.15)',
                      border: '1px solid rgba(99, 102, 241, 0.3)',
                      borderRadius: '10px',
                      padding: '12px 16px',
                      color: '#e2e8f0',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      textAlign: 'left',
                    }}
                  >
                    {label}
                  </button>
                ))}
              </div>
            </div>

            <button
              onClick={closeExport}
              style={{
                width: '100%',
                marginTop: '16px',
                padding: '14px',
                background: 'transparent',
                border: '1px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '12px',
                color: '#94a3b8',
                fontSize: '15px',
                cursor: 'pointer',
              }}
            >
              Cancel
            </button>
          </div>
        </div>
      )}

      {/* Insights Modal */}
      {showInsights && (() => {
        const data = getInsights(insightsWindow);
        
        return (
          <div 
            style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'linear-gradient(180deg, #0c0a1d 0%, #1a1333 100%)',
              zIndex: 100,
              overflowY: 'auto',
              padding: '20px 20px 120px 20px',
            }}
          >
            <div 
              style={{ maxWidth: '400px', margin: '0 auto' }}
            >
              {/* Header */}
              <div style={{
                marginBottom: '20px',
              }}>
                <h2 style={{ color: '#f8fafc', fontSize: '24px', fontWeight: '700', margin: 0 }}>
                  Insights
                </h2>
              </div>

              {/* Window Selector */}
              <div style={{
                display: 'flex',
                gap: '8px',
                marginBottom: '20px',
              }}>
                {[30, 60, 90].map(days => (
                  <button
                    key={days}
                    onClick={() => setInsightsWindow(days)}
                    style={{
                      flex: 1,
                      padding: '10px',
                      borderRadius: '10px',
                      border: insightsWindow === days 
                        ? '2px solid rgba(99, 102, 241, 0.6)' 
                        : '1px solid rgba(99, 102, 241, 0.2)',
                      background: insightsWindow === days 
                        ? 'rgba(99, 102, 241, 0.2)' 
                        : 'rgba(99, 102, 241, 0.05)',
                      color: insightsWindow === days ? '#fff' : '#94a3b8',
                      fontSize: '13px',
                      fontWeight: insightsWindow === days ? '600' : '400',
                      cursor: 'pointer',
                    }}
                  >
                    {days} days
                  </button>
                ))}
              </div>

              {!data.hasEnoughData ? (
                <div style={{
                  background: 'rgba(99, 102, 241, 0.1)',
                  border: '1px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '20px',
                  padding: '32px 24px',
                  textAlign: 'center',
                }}>
                  <div style={{ fontSize: '56px', marginBottom: '16px' }}>📊</div>
                  <p style={{ color: '#e2e8f0', fontSize: '18px', fontWeight: '600', margin: '0 0 8px 0' }}>
                    Keep tracking
                  </p>
                  <p style={{ color: '#94a3b8', fontSize: '14px', margin: 0 }}>
                    {data.daysOfData < data.minDaysNeeded 
                      ? `${data.minDaysNeeded - data.daysOfData} more days needed for ${insightsWindow}-day insights`
                      : `${20 - data.entriesCount} more entries needed`
                    }
                  </p>
                </div>
              ) : data.insights.length === 0 && !data.topCluster ? (
                <div style={{
                  background: 'rgba(99, 102, 241, 0.1)',
                  border: '1px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '20px',
                  padding: '32px 24px',
                  textAlign: 'center',
                }}>
                  <div style={{ fontSize: '56px', marginBottom: '16px' }}>📈</div>
                  <p style={{ color: '#e2e8f0', fontSize: '18px', fontWeight: '600', margin: '0 0 8px 0' }}>
                    No major changes
                  </p>
                  <p style={{ color: '#94a3b8', fontSize: '14px', margin: 0 }}>
                    Your symptoms have been relatively stable over the past {insightsWindow} days.
                  </p>
                </div>
              ) : (
                <>
                  {/* Big number tiles for significant changes */}
                  {data.insights.length > 0 && (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginBottom: '20px' }}>
                      {data.insights.map(insight => (
                        <div
                          key={insight.symptomId}
                          style={{
                            background: insight.direction === 'improving' 
                              ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(74, 222, 128, 0.1) 100%)'
                              : 'linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(251, 146, 60, 0.1) 100%)',
                            border: `2px solid ${insight.direction === 'improving' ? 'rgba(74, 222, 128, 0.4)' : 'rgba(239, 68, 68, 0.4)'}`,
                            borderRadius: '16px',
                            padding: '20px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '16px',
                          }}
                        >
                          <div style={{
                            fontSize: '36px',
                            fontWeight: '800',
                            color: insight.direction === 'improving' ? '#4ade80' : '#f87171',
                            minWidth: '90px',
                          }}>
                            {insight.direction === 'improving' ? '↓' : '↑'}{Math.abs(insight.percentChange)}%
                          </div>
                          <div>
                            <div style={{ color: '#f8fafc', fontSize: '15px', fontWeight: '600' }}>
                              {insight.name}
                            </div>
                            <div style={{ color: '#94a3b8', fontSize: '13px', marginTop: '4px' }}>
                              {insight.direction === 'improving' ? 'Improved' : 'Increased'} over {insightsWindow} days
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Symptom cluster if significant */}
                  {data.topCluster && (
                    <div style={{
                      background: 'linear-gradient(135deg, rgba(251, 146, 60, 0.15) 0%, rgba(251, 191, 36, 0.1) 100%)',
                      border: '2px solid rgba(251, 146, 60, 0.4)',
                      borderRadius: '16px',
                      padding: '20px',
                      marginBottom: '20px',
                    }}>
                      <div style={{
                        fontSize: '28px',
                        fontWeight: '800',
                        color: '#fbbf24',
                        marginBottom: '8px',
                      }}>
                        {data.topCluster.percent}% of days
                      </div>
                      <div style={{ color: '#f8fafc', fontSize: '14px' }}>
                        <strong>{data.topCluster.names[0]}</strong> and <strong>{data.topCluster.names[1]}</strong> appear together
                      </div>
                      <div style={{ color: '#94a3b8', fontSize: '12px', marginTop: '6px' }}>
                        These symptoms may be related
                      </div>
                    </div>
                  )}

                  {/* AI Analysis Button */}
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(data.aiPrompt);
                      setLastAction('Copied — paste into Claude for AI analysis');
                    }}
                    style={{
                      width: '100%',
                      background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(99, 102, 241, 0.15) 100%)',
                      border: '2px solid rgba(139, 92, 246, 0.4)',
                      borderRadius: '16px',
                      padding: '20px',
                      color: '#c4b5fd',
                      fontSize: '15px',
                      fontWeight: '600',
                      cursor: 'pointer',
                      textAlign: 'center',
                      marginBottom: '20px',
                    }}
                  >
                    <span style={{ fontSize: '20px', marginRight: '8px' }}>🤖</span>
                    Copy for AI Analysis
                  </button>

                  <p style={{
                    color: '#64748b',
                    fontSize: '11px',
                    textAlign: 'center',
                    margin: 0,
                  }}>
                    Based on {data.entriesCount} entries over {data.daysOfData} days. For informational purposes only.
                  </p>
                </>
              )}
            </div>
          </div>
        );
      })()}

      {/* Settings - Full Screen */}
      {showSettings && (
        <div 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'linear-gradient(180deg, #0c0a1d 0%, #1a1333 100%)',
            zIndex: 100,
            overflowY: 'auto',
            padding: '20px 20px 120px 20px',
          }}
        >
          <div style={{ maxWidth: '400px', margin: '0 auto' }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '24px',
            }}>
              <h2 style={{
                color: '#f8fafc',
                fontSize: '24px',
                fontWeight: '700',
                margin: 0,
              }}>
                Settings
              </h2>
            </div>
            
            {/* History & Export Row */}
            <div style={{ display: 'flex', gap: '12px', marginBottom: '20px' }}>
              <button
                onClick={() => {
                  setShowSettings(false);
                  setOpenedFromSettings(true);
                  setShowHistory(true);
                }}
                style={{
                  flex: 1,
                  background: 'rgba(99, 102, 241, 0.15)',
                  border: '2px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '12px',
                  padding: '16px',
                  color: '#a5b4fc',
                  fontSize: '15px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  textAlign: 'center',
                }}
              >
                📋 History
              </button>
              <button
                onClick={() => {
                  setShowSettings(false);
                  setOpenedFromSettings(true);
                  setShowExport(true);
                }}
                style={{
                  flex: 1,
                  background: 'rgba(99, 102, 241, 0.15)',
                  border: '2px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '12px',
                  padding: '16px',
                  color: '#a5b4fc',
                  fontSize: '15px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  textAlign: 'center',
                }}
              >
                📤 Export
              </button>
            </div>
            
            {/* Manage Symptoms Button */}
            <button
              onClick={() => {
                setShowSettings(false);
                setShowAddSymptom(true);
              }}
              style={{
                width: '100%',
                background: 'rgba(99, 102, 241, 0.15)',
                border: '2px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '12px',
                padding: '16px',
                color: '#a5b4fc',
                fontSize: '15px',
                fontWeight: '500',
                cursor: 'pointer',
                textAlign: 'left',
                marginBottom: '12px',
              }}
            >
              <div style={{ fontWeight: '600', marginBottom: '4px' }}>Manage Symptoms</div>
              <div style={{ fontSize: '12px', opacity: 0.8 }}>
                Add, edit, hide, or restore symptoms
              </div>
            </button>
            
            {/* Manage Stack Button */}
            <button
              onClick={() => {
                setShowSettings(false);
                setShowManageStack(true);
              }}
              style={{
                width: '100%',
                background: 'rgba(99, 102, 241, 0.15)',
                border: '2px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '12px',
                padding: '16px',
                color: '#a5b4fc',
                fontSize: '15px',
                fontWeight: '500',
                cursor: 'pointer',
                textAlign: 'left',
                marginBottom: '20px',
              }}
            >
              <div style={{ fontWeight: '600', marginBottom: '4px' }}>Manage Stack</div>
              <div style={{ fontSize: '12px', opacity: 0.8 }}>
                Add, edit, or remove supplements
              </div>
            </button>
            
            {/* Tracking Mode Selection */}
            <div style={{ marginBottom: '20px' }}>
              <label style={{
                color: '#94a3b8',
                fontSize: '12px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
                display: 'block',
                marginBottom: '12px',
              }}>Tracking Mode</label>
              <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                {Object.entries(trackingModes).map(([key, mode]) => (
                  <button
                    key={key}
                    onClick={() => setTrackingMode(key)}
                    style={{
                      background: trackingMode === key ? 'rgba(99, 102, 241, 0.25)' : 'rgba(99, 102, 241, 0.1)',
                      border: trackingMode === key ? '2px solid rgba(99, 102, 241, 0.6)' : '2px solid rgba(99, 102, 241, 0.2)',
                      borderRadius: '12px',
                      padding: '12px 16px',
                      color: trackingMode === key ? '#fff' : '#a5b4fc',
                      fontSize: '14px',
                      fontWeight: '500',
                      cursor: 'pointer',
                      textAlign: 'left',
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                    }}
                  >
                    <div>
                      <div style={{ fontWeight: '600' }}>{mode.label}</div>
                      <div style={{ fontSize: '11px', opacity: 0.7, marginTop: '2px' }}>{mode.description}</div>
                    </div>
                    {trackingMode === key && <span style={{ fontSize: '16px' }}>✓</span>}
                  </button>
                ))}
              </div>
            </div>
            
            {/* iCloud / File Backup */}
            <div style={{ marginBottom: '20px' }}>
              <label style={{
                color: '#94a3b8',
                fontSize: '12px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
                display: 'block',
                marginBottom: '12px',
              }}>iCloud Backup</label>
              
              <div style={{
                background: 'rgba(99, 102, 241, 0.1)',
                border: '1px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '12px',
                padding: '14px',
              }}>
                <p style={{ 
                  color: '#94a3b8', 
                  fontSize: '12px', 
                  margin: '0 0 12px 0',
                  lineHeight: '1.4',
                }}>
                  Save backup to Files → iCloud Drive to sync between devices
                </p>
                
                <div style={{ display: 'flex', gap: '8px' }}>
                  <button
                    onClick={backupToFile}
                    style={{
                      flex: 1,
                      background: 'rgba(74, 222, 128, 0.15)',
                      border: '1px solid rgba(74, 222, 128, 0.3)',
                      borderRadius: '8px',
                      padding: '12px',
                      color: '#86efac',
                      fontSize: '13px',
                      fontWeight: '600',
                      cursor: 'pointer',
                    }}
                  >
                    ↓ Save Backup
                  </button>
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    style={{
                      flex: 1,
                      background: 'rgba(99, 102, 241, 0.15)',
                      border: '1px solid rgba(99, 102, 241, 0.3)',
                      borderRadius: '8px',
                      padding: '12px',
                      color: '#a5b4fc',
                      fontSize: '13px',
                      fontWeight: '600',
                      cursor: 'pointer',
                    }}
                  >
                    ↑ Load Backup
                  </button>
                </div>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept=".json"
                  onChange={restoreFromFile}
                  style={{ display: 'none' }}
                />
              </div>
            </div>
            
            {/* Google Drive Sync */}
            <div style={{ marginBottom: '20px' }}>
              <label style={{
                color: '#94a3b8',
                fontSize: '12px',
                textTransform: 'uppercase',
                letterSpacing: '1px',
                display: 'block',
                marginBottom: '12px',
              }}>Google Drive Sync</label>
              
              {GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID.apps.googleusercontent.com' ? (
                <div style={{
                  background: 'rgba(251, 191, 36, 0.1)',
                  border: '1px solid rgba(251, 191, 36, 0.3)',
                  borderRadius: '12px',
                  padding: '12px',
                  color: '#fcd34d',
                  fontSize: '12px',
                }}>
                  <div style={{ fontWeight: '600', marginBottom: '4px' }}>Setup Required</div>
                  <div style={{ opacity: 0.9 }}>
                    To enable Google sync, you need to configure a Google Cloud project and add your Client ID to the code.
                  </div>
                </div>
              ) : !googleUser ? (
                <button
                  onClick={handleGoogleSignIn}
                  disabled={!googleApiReady}
                  style={{
                    width: '100%',
                    background: googleApiReady ? 'rgba(66, 133, 244, 0.15)' : 'rgba(100, 116, 139, 0.1)',
                    border: `2px solid ${googleApiReady ? 'rgba(66, 133, 244, 0.3)' : 'rgba(100, 116, 139, 0.2)'}`,
                    borderRadius: '12px',
                    padding: '14px',
                    color: googleApiReady ? '#93c5fd' : '#64748b',
                    fontSize: '14px',
                    fontWeight: '500',
                    cursor: googleApiReady ? 'pointer' : 'not-allowed',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                  }}
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                  </svg>
                  {googleApiReady ? 'Sign in with Google' : 'Loading...'}
                </button>
              ) : (
                <div style={{
                  background: 'rgba(99, 102, 241, 0.1)',
                  border: '1px solid rgba(99, 102, 241, 0.3)',
                  borderRadius: '12px',
                  padding: '12px',
                }}>
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: '10px',
                  }}>
                    <span style={{ color: '#86efac', fontSize: '13px', fontWeight: '500' }}>
                      ✓ Connected to Google
                    </span>
                    <button
                      onClick={handleGoogleSignOut}
                      style={{
                        background: 'transparent',
                        border: 'none',
                        color: '#94a3b8',
                        fontSize: '12px',
                        cursor: 'pointer',
                        textDecoration: 'underline',
                      }}
                    >
                      Sign out
                    </button>
                  </div>
                  
                  {lastSyncTime && (
                    <div style={{ color: '#94a3b8', fontSize: '11px', marginBottom: '10px' }}>
                      Last sync: {lastSyncTime.toLocaleString()}
                    </div>
                  )}
                  
                  <div style={{ display: 'flex', gap: '8px' }}>
                    <button
                      onClick={saveToGoogleDrive}
                      disabled={syncStatus === 'syncing'}
                      style={{
                        flex: 1,
                        background: 'rgba(74, 222, 128, 0.15)',
                        border: '1px solid rgba(74, 222, 128, 0.3)',
                        borderRadius: '8px',
                        padding: '10px',
                        color: '#86efac',
                        fontSize: '13px',
                        cursor: syncStatus === 'syncing' ? 'wait' : 'pointer',
                      }}
                    >
                      {syncStatus === 'syncing' ? '...' : '↑ Save'}
                    </button>
                    <button
                      onClick={loadFromGoogleDrive}
                      disabled={syncStatus === 'syncing'}
                      style={{
                        flex: 1,
                        background: 'rgba(99, 102, 241, 0.15)',
                        border: '1px solid rgba(99, 102, 241, 0.3)',
                        borderRadius: '8px',
                        padding: '10px',
                        color: '#a5b4fc',
                        fontSize: '13px',
                        cursor: syncStatus === 'syncing' ? 'wait' : 'pointer',
                      }}
                    >
                      {syncStatus === 'syncing' ? '...' : '↓ Load'}
                    </button>
                  </div>
                  
                  {syncStatus === 'success' && (
                    <div style={{ color: '#86efac', fontSize: '11px', marginTop: '8px', textAlign: 'center' }}>
                      ✓ Sync successful
                    </div>
                  )}
                  {syncStatus === 'error' && (
                    <div style={{ color: '#fca5a5', fontSize: '11px', marginTop: '8px', textAlign: 'center' }}>
                      ✗ Sync failed
                    </div>
                  )}
                </div>
              )}
            </div>
            
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {!hasSampleData && (
                <button
                  onClick={loadSampleData}
                  style={{
                    background: 'rgba(74, 222, 128, 0.15)',
                    border: '2px solid rgba(74, 222, 128, 0.3)',
                    borderRadius: '12px',
                    padding: '16px',
                    color: '#86efac',
                    fontSize: '15px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    textAlign: 'left',
                  }}
                >
                  <div style={{ fontWeight: '600', marginBottom: '4px' }}>Load Sample Data</div>
                  <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Generate 6 months of example entries with trends
                  </div>
                </button>
              )}

              {!confirmClearData ? (
                <button
                  onClick={clearAllData}
                  style={{
                    background: 'rgba(239, 68, 68, 0.15)',
                    border: '2px solid rgba(239, 68, 68, 0.3)',
                    borderRadius: '12px',
                    padding: '16px',
                    color: '#fca5a5',
                    fontSize: '15px',
                    fontWeight: '500',
                    cursor: 'pointer',
                    textAlign: 'left',
                  }}
                >
                  <div style={{ fontWeight: '600', marginBottom: '4px' }}>Clear All Data</div>
                  <div style={{ fontSize: '12px', opacity: 0.8 }}>
                    Remove all recorded entries
                  </div>
                </button>
              ) : (
                <div style={{
                  background: 'rgba(239, 68, 68, 0.2)',
                  border: '2px solid rgba(239, 68, 68, 0.5)',
                  borderRadius: '12px',
                  padding: '16px',
                }}>
                  <div style={{ color: '#fca5a5', fontWeight: '600', marginBottom: '12px', textAlign: 'center' }}>
                    ⚠️ Are you sure? This cannot be undone.
                  </div>
                  <div style={{ display: 'flex', gap: '10px' }}>
                    <button
                      onClick={() => setConfirmClearData(false)}
                      style={{
                        flex: 1,
                        background: 'rgba(99, 102, 241, 0.2)',
                        border: '1px solid rgba(99, 102, 241, 0.4)',
                        borderRadius: '8px',
                        padding: '12px',
                        color: '#a5b4fc',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                      }}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={clearAllData}
                      style={{
                        flex: 1,
                        background: 'rgba(239, 68, 68, 0.3)',
                        border: '1px solid rgba(239, 68, 68, 0.5)',
                        borderRadius: '8px',
                        padding: '12px',
                        color: '#fca5a5',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                      }}
                    >
                      Yes, Clear All
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Manage Stack Modal */}
      {showManageStack && (
        <div style={{
          position: 'fixed',
          inset: 0,
          background: 'rgba(0,0,0,0.9)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          zIndex: 1000,
        }}>
          <div style={{
            background: 'linear-gradient(180deg, #1e1b4b 0%, #0f0a2e 100%)',
            borderRadius: '20px',
            padding: '24px',
            width: '100%',
            maxWidth: '400px',
            maxHeight: '85vh',
            overflowY: 'auto',
          }}>
            <h2 style={{ color: '#f8fafc', marginTop: 0, marginBottom: '20px' }}>Manage Stack</h2>
            
            {/* Add new item - always visible */}
            <div style={{
              background: 'rgba(15, 23, 42, 0.6)',
              borderRadius: '12px',
              padding: '14px',
              marginBottom: '16px',
            }}>
              <div style={{ display: 'flex', gap: '8px', marginBottom: '10px' }}>
                <input
                  type="text"
                  placeholder="Supplement name"
                  value={newStackItem.name}
                  onChange={(e) => setNewStackItem({...newStackItem, name: e.target.value})}
                  style={{
                    flex: 1,
                    background: 'rgba(15, 23, 42, 0.8)',
                    border: '1px solid rgba(99, 102, 241, 0.3)',
                    borderRadius: '8px',
                    padding: '10px 12px',
                    color: '#f8fafc',
                    fontSize: '14px',
                    boxSizing: 'border-box',
                  }}
                />
              </div>
              <div style={{ display: 'flex', gap: '8px' }}>
                <input
                  type="text"
                  inputMode="decimal"
                  placeholder="Dose"
                  value={newStackItem.defaultDose}
                  onChange={(e) => setNewStackItem({...newStackItem, defaultDose: e.target.value})}
                  style={{
                    width: '70px',
                    background: 'rgba(15, 23, 42, 0.8)',
                    border: '1px solid rgba(99, 102, 241, 0.3)',
                    borderRadius: '8px',
                    padding: '10px 12px',
                    color: '#f8fafc',
                    fontSize: '14px',
                    textAlign: 'center',
                  }}
                />
                <select
                  value={newStackItem.unit}
                  onChange={(e) => setNewStackItem({...newStackItem, unit: e.target.value})}
                  style={{
                    width: '70px',
                    background: 'rgba(15, 23, 42, 0.8)',
                    border: '1px solid rgba(99, 102, 241, 0.3)',
                    borderRadius: '8px',
                    padding: '10px 8px',
                    color: '#f8fafc',
                    fontSize: '14px',
                  }}
                >
                  <option value="mg">mg</option>
                  <option value="mcg">mcg</option>
                  <option value="g">g</option>
                  <option value="IU">IU</option>
                  <option value="ml">ml</option>
                  <option value="drops">drops</option>
                </select>
                <button
                  onClick={addStackItem}
                  disabled={!newStackItem.name.trim() || !newStackItem.defaultDose}
                  style={{
                    flex: 1,
                    background: (!newStackItem.name.trim() || !newStackItem.defaultDose) 
                      ? 'rgba(34, 197, 94, 0.2)' 
                      : '#22c55e',
                    border: 'none',
                    borderRadius: '8px',
                    padding: '10px',
                    color: '#fff',
                    fontSize: '14px',
                    fontWeight: '600',
                    cursor: 'pointer',
                  }}
                >
                  + Add
                </button>
              </div>
            </div>
            
            {/* List of items */}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
              {stackItems.sort((a, b) => (a.order || 0) - (b.order || 0)).map(item => (
                <div 
                  key={item.id}
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    background: 'rgba(15, 23, 42, 0.4)',
                    borderRadius: '10px',
                    padding: '12px 14px',
                    opacity: item.active ? 1 : 0.5,
                  }}
                >
                  <div>
                    <span style={{ color: '#e2e8f0', fontSize: '14px' }}>{item.name}</span>
                    <span style={{ color: '#64748b', fontSize: '12px', marginLeft: '8px' }}>
                      {item.defaultDose} {item.unit}
                    </span>
                  </div>
                  <button
                    onClick={() => toggleStackItemActive(item.id)}
                    style={{
                      background: item.active ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)',
                      border: 'none',
                      borderRadius: '6px',
                      width: '28px',
                      height: '28px',
                      color: item.active ? '#f87171' : '#4ade80',
                      fontSize: '14px',
                      cursor: 'pointer',
                    }}
                  >
                    {item.active ? '✕' : '+'}
                  </button>
                </div>
              ))}
              {stackItems.length === 0 && (
                <p style={{ color: '#64748b', textAlign: 'center', padding: '20px' }}>
                  No supplements added yet
                </p>
              )}
            </div>

            <button
              onClick={() => {
                setShowManageStack(false);
                setShowAddStackItem(false);
              }}
              style={{
                width: '100%',
                background: 'rgba(99, 102, 241, 0.15)',
                border: '1px solid rgba(99, 102, 241, 0.3)',
                borderRadius: '10px',
                padding: '14px',
                color: '#a5b4fc',
                fontSize: '15px',
                fontWeight: '600',
                cursor: 'pointer',
              }}
            >
              Done
            </button>
          </div>
        </div>
      )}

      {/* Success Toast */}
      {lastAction && !isDragging && !showAddSymptom && !showCalendar && !showHistory && !showExport && !showSettings && !showInsights && !showManageStack && (
        <div style={{
          position: 'fixed',
          bottom: '90px',
          left: '50%',
          transform: 'translateX(-50%)',
          background: 'rgba(30, 27, 75, 0.95)',
          border: '1px solid rgba(99, 102, 241, 0.4)',
          borderRadius: '10px',
          padding: '10px 18px',
          color: '#a5b4fc',
          fontSize: '13px',
          fontWeight: '500',
          boxShadow: '0 10px 40px rgba(0,0,0,0.4)',
          animation: 'slideUpFade 3s ease forwards',
        }}>
          ✓ {lastAction}
        </div>
      )}

      <style>{`
        @keyframes slideUpFade {
          0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
          10% { opacity: 1; transform: translateX(-50%) translateY(0); }
          80% { opacity: 1; transform: translateX(-50%) translateY(0); }
          100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
        input::placeholder, textarea::placeholder {
          color: #64748b;
        }
        * {
          -webkit-user-select: none;
          -webkit-touch-callout: none;
          -webkit-tap-highlight-color: transparent;
          user-select: none;
        }
        input, textarea {
          -webkit-user-select: text;
          user-select: text;
        }
      `}</style>
    </div>
  );
}

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SymptomTrackerMobile />);
  </script>
</body>
</html>
